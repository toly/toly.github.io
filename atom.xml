<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Toly blog]]></title>
  <link href="http://toly.github.io/atom.xml" rel="self"/>
  <link href="http://toly.github.io/"/>
  <updated>2014-03-23T19:50:56+04:00</updated>
  <id>http://toly.github.io/</id>
  <author>
    <name><![CDATA[Toly]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Проект на Django Rest Framework и AngularJS]]></title>
    <link href="http://toly.github.io/blog/2014/03/14/getting-started-with-django-rest-framework-and-angularjs/"/>
    <updated>2014-03-14T22:13:12+04:00</updated>
    <id>http://toly.github.io/blog/2014/03/14/getting-started-with-django-rest-framework-and-angularjs</id>
    <content type="html"><![CDATA[<blockquote>
  <p>Перевод статьи Кевина Стоуна <a href="http://blog.kevinastone.com/getting-started-with-django-rest-framework-and-angularjs.html">Getting Started with Django Rest Framework and AngularJS</a></p>
</blockquote>

<p>RESTful API становится стандартным компонентом любого современного веб-приложения. <em>Django Rest Framework</em> является мощным фреймворком для разработки REST API на основе вашего Django проекта. <em>AngularJS</em> - современный JavaScript фреймворк для создания сложных клиентских веб-приложений. Он фокусируется на сильном разделении функциональных частей (MVC) и использовании зависимостей для поощрения создания поддерживаемых (и тестируемых) модулей, которые будучи интегрированными предоставляли богатую функциональность на стороне клиента.</p>

<p>В этом посте я покажу создание проекта для примера, который преоставляет REST API, используемый фреймворком AngularJS на клиенте, что бы продемонстрировать как совместно использовать бекенд и фронтенд для упрощения создания сложных приложений.</p>

<!-- more -->

<h2 id="django-">Давайте сделаем тестовый Django проект</h2>

<p>Для примера, давайте создадим простое приложение для обмена фотографиями (что-то типа примитивного Instagram) и выдачи ленты для отдельного пользователя, что бы смотреть фотографии размещенные на сайте.</p>

<p>Все примеры кода для этого проекта доступны в <a href="https://github.com/kevinastone/django-api-rest-and-angular">репозитории на github</a>. Что бы установить тестовый проект локально, ознакомьтесь с <a href="https://github.com/kevinastone/django-api-rest-and-angular/blob/master/Readme.markdown">инструкцией по установке</a>, включенной в репозиторий. Там же описана установка AngularJS (и других javascript библиотек) через <a href="http://yeoman.io/"><strong>bower</strong> и <strong>grunt</strong></a>.</p>

<p>Наконец, есть тестовые данные, доступные в виде фикстур, для демонстрации API. У нас есть несколько пользователей ([‘Bob’, ‘Sally’, ‘Joe’, ‘Rachel’]), два поста ([‘This is a great post’, ‘Another thing I wanted to share’]) и также несколько тестовых фотографий. Прилагаемый <em>Makefile</em> строит для вас тестовые данные.</p>

<p>Несколько замечаний о примерах кода:</p>

<ul>
  <li>Я пропущу подробности конфигурирования, сборки и запуска приложения. В инструкции, размещенной в репозитории, описаны многие из этих деталей. Если что - сообщайте о любых приблемах на github.</li>
  <li>Я написал код клиентской части на <strong>Coffee-Script</strong>, так как считаю его более понятным и более эффективным (и немного питоничным). В репозитории находится Grun-файл, который собирает все Coffee-Script файлы объединяет их в один файл - script.js для использования на клиенте.</li>
</ul>

<h2 id="section">Уровень данных проекта (модели)</h2>

<p>Наша модель данных такая же простая, как и в водном уроке для Django. У вас есть три модели: User (пользователь), Post (пост) и Photo (фотография). Пользователь может быть автором множества постов (а также иметь много фолловеров), пост может содержать много фотографий (что-то вроде альбома или галлереи) вместе с названием и необязательным описанием.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractUser</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">):</span>
</span><span class="line">    <span class="n">followers</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;followees&#39;</span><span class="p">,</span> <span class="n">symmetrical</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;posts&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
</span><span class="line">    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Photo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;photos&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s">&quot;%Y/%m/</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="api--django-rest-framework">API на Django Rest Framework</h2>

<p>Django Rest Framework предоставляет готовую архитектуру для разработки как простых RESTful API, так и более сложных конструкций. Его ключевая особенность, это четкое разделение на сериализаторы, которые описывают соответствие между моделью и ее форматом представления (будь то JSON, XML или любой другой формат), и на отдельный набор универсальных представлениях на основе классов (Class-Based-Views), которые могут быть по необходимости расширены. Вы так же можете определить свою ссылочную структуру, вместо использования дефолтной. Это то, что отличает Django Rest Framework от других фреймворков, таких как Tastypie и Piston, которые автоматизируют формировнаие API на основе моделей, но это происходит за счет снижения гибкости и применимости к различным нестандартным требованиям (особенно, если речь идет о доступах и вложенных ресурсах).</p>

<h2 id="section-1">Сериализаторы моделей</h2>

<p>Сериализаторы в Django Rest Framework предназначены для преобразования экземпляров django-модели в API представление. Это дает нам возможность конвертировать любые типы данных, или предоставлять дополнительную информацию о данной модели. Например, для пользователя, мы только откроем некоторые поля, скрывая некоторые аттрибуты, такие как пароль и адрес електронной почты. Для фото, мы сконвертируем ImageField так, что бы возвращалась ссылка на изображение (а не путь во внутреннем медиа каталоге).</p>

<p>Для сериализатора <code>PostSerializer</code>, мы выбрали вставку данных автора прямо в пост (до этого в поле <code>author</code> была ссылка на данные автора). Это делает информацию доступнее для клиентской части, и не требует дополнительных запросов к API для дублирующихся авторов каждого поста. Альтернативный вариант сс сылкой на автора предоставлен закомментированной строкой для сравнения. Сильной стороной сериализаторов является то, что их можно расширить для создания дополнительных версий, которые используют ссылки на данные автора вместо вложенных данных (например, для вывода списка постов одного пользователя).</p>

<p>Что бы привязать данные автора к <code>PostSerializer</code>, нам придется сделать так, что бы эти данные поддерживались API представлением. Поэтому мы сделаем поле автора необязательным (<code>required=False</code>) в сериализаторе поста и добавим его в исключения валидации.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Post</span><span class="p">,</span> <span class="n">Photo</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span><span class="line">    <span class="n">posts</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedIdentityField</span><span class="p">(</span><span class="s">&#39;posts&#39;</span><span class="p">,</span> <span class="n">view_name</span><span class="o">=</span><span class="s">&#39;userpost-list&#39;</span><span class="p">,</span> <span class="n">lookup_field</span><span class="o">=</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span><span class="line">        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
</span><span class="line">        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="s">&#39;first_name&#39;</span><span class="p">,</span> <span class="s">&#39;last_name&#39;</span><span class="p">,</span> <span class="s">&#39;posts&#39;</span><span class="p">,</span> <span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span><span class="line">    <span class="n">author</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">    <span class="n">photos</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedIdentityField</span><span class="p">(</span><span class="s">&#39;photos&#39;</span><span class="p">,</span> <span class="n">view_name</span><span class="o">=</span><span class="s">&#39;postphoto-list&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="c"># author = serializers.HyperlinkedRelatedField(view_name=&#39;user-detail&#39;, lookup_field=&#39;username&#39;)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_validation_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="c"># Need to exclude `author` since we&#39;ll add that later based off the request</span>
</span><span class="line">        <span class="n">exclusions</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PostSerializer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_validation_exclusions</span><span class="p">()</span>
</span><span class="line">        <span class="k">return</span> <span class="n">exclusions</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span><span class="line">        <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PhotoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
</span><span class="line">    <span class="n">image</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s">&#39;image.url&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span><span class="line">        <span class="n">model</span> <span class="o">=</span> <span class="n">Photo</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Хорошо, загрузив тестовые данные, давайте попробуем поработать с этими сериализаторами. Возможно вы увидите предупреджающие сообщения <code>DeprecationWarning</code> из-за использования <code>HyperlinkedIdentityField</code> без предоставления объекта запроса для построения ссылки. В настоящих представлениях объект запроса присутствует, так что вы можете спокойно игнорировать эти сообщения.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">example.api.models</span> <span class="kn">import</span> <span class="n">User</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;bob&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">example.api.serializers</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">UserSerializer</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
</span><span class="line"><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">u&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;first_name&#39;</span><span class="p">:</span> <span class="s">u&#39;Bob&#39;</span><span class="p">,</span> <span class="s">&#39;last_name&#39;</span><span class="p">:</span> <span class="s">u&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;posts&#39;</span><span class="p">:</span> <span class="s">&#39;/api/users/bob/posts&#39;</span><span class="p">}</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">PostSerializer</span><span class="p">(</span><span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span class="line"><span class="p">{</span><span class="s">&#39;author&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">u&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;first_name&#39;</span><span class="p">:</span> <span class="s">u&#39;Bob&#39;</span><span class="p">,</span> <span class="s">&#39;last_name&#39;</span><span class="p">:</span> <span class="s">u&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;posts&#39;</span><span class="p">:</span> <span class="s">&#39;/api/users/bob/posts&#39;</span><span class="p">},</span> <span class="s">&#39;photos&#39;</span><span class="p">:</span> <span class="s">&#39;/api/posts/2/photos&#39;</span><span class="p">,</span> <span class="s">u&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">u&#39;Title #2&#39;</span><span class="p">,</span> <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="s">u&#39;Another thing I wanted to share&#39;</span><span class="p">}</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">PostSerializer</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
</span><span class="line"><span class="p">[{</span><span class="s">&#39;author&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">u&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;first_name&#39;</span><span class="p">:</span> <span class="s">u&#39;Bob&#39;</span><span class="p">,</span> <span class="s">&#39;last_name&#39;</span><span class="p">:</span> <span class="s">u&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;posts&#39;</span><span class="p">:</span> <span class="s">&#39;/api/users/bob/posts&#39;</span><span class="p">},</span> <span class="s">&#39;photos&#39;</span><span class="p">:</span> <span class="s">&#39;/api/posts/2/photos&#39;</span><span class="p">,</span> <span class="s">u&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">u&#39;Title #2&#39;</span><span class="p">,</span> <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="s">u&#39;Another thing I wanted to share&#39;</span><span class="p">}]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="api">Ссылочная структура API</h2>

<p>Для нашего API, мы хотим использовать относительно плоскую структуру, что бы попытаться определить типичные сущности для данного API,  но так же и обеспечить некоторые вспомогательные вложенные данные для фильтрации (например, посты определенного пользователя или фотографии определенного поста). Обратите внимание, что мы используем первичные ключи (primary key) моделей в качестве идентификатора, но для пользователей мы используем его имя, так как он так же является уникальным (позже мы увидим это в предствалениях).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">.api</span> <span class="kn">import</span> <span class="n">UserList</span><span class="p">,</span> <span class="n">UserDetail</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">.api</span> <span class="kn">import</span> <span class="n">PostList</span><span class="p">,</span> <span class="n">PostDetail</span><span class="p">,</span> <span class="n">UserPostList</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">.api</span> <span class="kn">import</span> <span class="n">PhotoList</span><span class="p">,</span> <span class="n">PhotoDetail</span><span class="p">,</span> <span class="n">PostPhotoList</span>
</span><span class="line">
</span><span class="line"><span class="n">user_urls</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^/(?P&lt;username&gt;[0-9a-zA-Z_-]+)/posts$&#39;</span><span class="p">,</span> <span class="n">UserPostList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;userpost-list&#39;</span><span class="p">),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^/(?P&lt;username&gt;[0-9a-zA-Z_-]+)$&#39;</span><span class="p">,</span> <span class="n">UserDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;user-detail&#39;</span><span class="p">),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">UserList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;user-list&#39;</span><span class="p">)</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">post_urls</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^/(?P&lt;pk&gt;\d+)/photos$&#39;</span><span class="p">,</span> <span class="n">PostPhotoList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;postphoto-list&#39;</span><span class="p">),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^/(?P&lt;pk&gt;\d+)$&#39;</span><span class="p">,</span> <span class="n">PostDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;post-detail&#39;</span><span class="p">),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">PostList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;post-list&#39;</span><span class="p">)</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">photo_urls</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^/(?P&lt;pk&gt;\d+)$&#39;</span><span class="p">,</span> <span class="n">PhotoDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;photo-detail&#39;</span><span class="p">),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">PhotoList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;photo-list&#39;</span><span class="p">)</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^users&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">user_urls</span><span class="p">)),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^posts&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">post_urls</span><span class="p">)),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^photos&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">photo_urls</span><span class="p">)),</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="api-1">Представления API</h2>

<p>Сильной стороной Django Rest Framework является набор базовых представлений, которые позволяют легко решать распространенные задачи связанные с CRUD практически без изменений. Для простейших представлений, вы предоставляете <code>model</code> и <code>serializer_class</code>, и расширяете одним из встроенных представлений (таким как <code>ListAPIView</code> или <code>RetrieveAPIView</code>).</p>

<p>В нашем случае мы имее пару настроек. Во-первых, для пользователей в качестве поля поиска мы будем использовать поле <code>username</code>, вместо <code>pk</code>. Поэтому мы устанавливаем поле <code>lookup_field</code>.</p>

<p>Мы так же хотели создать вложенные данные представлений для постов пользователей и фотографий поста. Для этого просто переопределим метод представления <code>get_queryset</code> так, что бы он фильтровал результаты по вложенным параметрам (<code>username</code> и <code>pk</code>, соответственно).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span><span class="p">,</span> <span class="n">permissions</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">UserSerializer</span><span class="p">,</span> <span class="n">PostSerializer</span><span class="p">,</span> <span class="n">PhotoSerializer</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Post</span><span class="p">,</span> <span class="n">Photo</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">UserList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</span><span class="line">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">        <span class="n">permissions</span><span class="o">.</span><span class="n">AllowAny</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">UserDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</span><span class="line">    <span class="n">lookup_field</span> <span class="o">=</span> <span class="s">&#39;username&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span><span class="line">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">        <span class="n">permissions</span><span class="o">.</span><span class="n">AllowAny</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span><span class="line">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">        <span class="n">permissions</span><span class="o">.</span><span class="n">AllowAny</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">UserPostList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UserPostList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span class="line">        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author__username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PhotoList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">Photo</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PhotoSerializer</span>
</span><span class="line">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">        <span class="n">permissions</span><span class="o">.</span><span class="n">AllowAny</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PhotoDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">Photo</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PhotoSerializer</span>
</span><span class="line">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">        <span class="n">permissions</span><span class="o">.</span><span class="n">AllowAny</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostPhotoList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">Photo</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PhotoSerializer</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PostPhotoList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span class="line">        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post__pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="api-2">Лирическое отступление: встроенный браузер API</h1>

<p>Одним из преимуществ Django Rest Framework является то, что он поставляется со встроенным браузером API для тестирования вашего API. Очень похожий на Django админку, он может помочь в начале разработки.</p>

<p>Просто загрузив одну из ваших API сущностей в браузер, Django Rest Framework предоставит вам удобный клиентсткий интерфейс для взаимодействия с API.</p>

<p><img class="left" src="http://toly.github.io/images/DRF_Angular/browser_user_posts.png" width="300" /> <img class="left" src="http://toly.github.io/images/DRF_Angular/browser_users.png" width="300" /></p>

<h2 id="api-3">Добавление прав доступа и принадлежности в API</h2>

<p>Как написано выше, наши представления API позволяют любому создавать что-либо на нашем сайте. Одним из преимуществ использования Django Rest Framework является наличие типичных представлений, делающих простым управление доступом в представлении без влияния на основную модель и сериализаторы. Что бы включить контроль над тем, кому разрешено редактировать наши API ресурсы, мы можем создать несколько классов, которые обеспечивают управление авторизацией для ограничения доступа. Они должны возвращать логическое значение для каждого запроса. Это дает нам доступ к полному запросу, в том числе куки, аутентифицированного пользователя и многое другое.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">SafeMethodsOnlyPermission</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Only can access non-destructive methods (like GET and HEAD)&quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_object_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostAuthorCanEditPermission</span><span class="p">(</span><span class="n">SafeMethodsOnlyPermission</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Allow everyone to list or view, but only the other can modify existing instances&quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="line">            <span class="c"># Either a list or a create, so no author</span>
</span><span class="line">            <span class="n">can_edit</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">can_edit</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">author</span>
</span><span class="line">        <span class="k">return</span> <span class="n">can_edit</span> <span class="ow">or</span> <span class="nb">super</span><span class="p">(</span><span class="n">PostAuthorCanEditPermission</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">has_object_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Кроме использования элементарной авторизации, мы также хотим, что бы предварительно заполнялись значения при сохранении в зависимости от того, кто делает запрос. Когда кто-то создает новый пост, мы хотим, что бы он автоматически назначался автором этого поста. Что бы устранить дублирование между <code>PostList</code> и <code>PostDetail</code> мы можем создать миксин, который будет содержать общую конфигурацию.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">PostMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
</span><span class="line">    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PostSerializer</span>
</span><span class="line">    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">        <span class="n">PostAuthorCanEditPermission</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">pre_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span><span class="line">        <span class="sd">&quot;&quot;&quot;Force author to the current user on save&quot;&quot;&quot;</span>
</span><span class="line">        <span class="n">obj</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
</span><span class="line">        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PostMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pre_save</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostList</span><span class="p">(</span><span class="n">PostMixin</span><span class="p">,</span> <span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="k">pass</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PostDetail</span><span class="p">(</span><span class="n">PostMixin</span><span class="p">,</span> <span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
</span><span class="line">    <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="api--angularjs">Использование API через AngularJS</h2>

<p>С появлением более интерактивных веб-приложений, RESTful API могут быть использованы в сложных клиентских интерфейсах, что бы получать и взаимодействовать с моделью данных приложения. AngularJS может здорово помочь в этом, из-за его сильного разделения элементов управления. Модульная архитектура AngularJS является настраиваемой. Ваше приложение состоит из модулей, которые определяют сервисы, директивы и контроллеры, и таким образом функционал оказывается разложенным по полочкам.</p>

<p>Преимуществом AngularJS является то, что он предоставляет возможность <a href="http://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">реактивного программирования</a> используя свой язык JavaScript-подобных выражений. Мы можем просто определить шаблон, который ссылается на переменные и наша страница будет автоматически обновлена при изменении этих переменных.</p>

<p>Для простейшего примера, мы просто выведем список постов в нашем приложении. Ниже приведен минимальный шаблон для AngularJS. Во-первых, на самом верхнем теге (<code>body</code>) мы укажем, какое приложение Angular используется для запуска этой страницы (<code>example.app.basic</code>), которое мы определим как корневой модуль. Во-вторых, нам нужен специальный контроллер, который будет управлять нашим шаблоном (<code>AppController</code>). Контроллер, в терминологии AbgularJS, больше соответствует связке модели и контроллера в традиционном MVC (c объектом $scope, содержащим состояние модели). Контроллеры определяют области видимости, которые содержат экземпляры модели, и они могут быть вложенными, чтобы ограничить область видимости по мере спускания по дереву DOM. И, наконец, мы используем директиву Angular (<code>ng-repeat</code>), которая является управляющей структурой для перебора наших моделей постов, хранящихся в <code>$state</code>. Внутри блока этой итерации, мы определяем несколько тегов и используем Angular-выражения (похожие на шаблонные теги Django), чтобы вывести имя пользователя автора, заголовок и содержание поста.</p>

<blockquote>
  <p>Используйте тег <code>verbatim</code> для включения Angular-выражений, что бы Django не пытался их отрендерить.</p>
</blockquote>

<blockquote>
  <p>Я заключил некоторые части шаблона в джанговсий тег <code>{% block %}</code>, чтобы потом наследовать этот шаблон для каждого из примеров.</p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="django"><span class="line"><span class="cp">{%</span> <span class="k">load</span> <span class="nv">staticfiles</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line">
</span><span class="line"><span class="x">&lt;html&gt;</span>
</span><span class="line"><span class="x">&lt;head&gt;</span>
</span><span class="line"><span class="x">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s2">&quot;bootstrap/dist/css/bootstrap.css&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
</span><span class="line"><span class="x">&lt;/head&gt;</span>
</span><span class="line"><span class="x">&lt;body ng-app=&quot;</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">ng_app</span> <span class="cp">%}</span><span class="x">example.app.static</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span>
</span><span class="line"><span class="x">&lt;div class=&quot;content&quot; ng-controller=&quot;</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">ng_controller</span> <span class="cp">%}</span><span class="x">AppController</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">verbatim</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="x">    &lt;div class=&quot;panel&quot; ng-repeat=&quot;post in posts&quot;&gt;</span>
</span><span class="line"><span class="x">        &lt;div class=&quot;panel-heading clearfix&quot;&gt;</span>
</span><span class="line"><span class="x">            &lt;h3 class=&quot;panel-title&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.title</span> <span class="cp">}}</span><span class="x">&lt;/h3&gt;</span>
</span><span class="line"><span class="x">            &lt;author class=&quot;pull-right&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.author.username</span> <span class="cp">}}</span><span class="x">&lt;/author&gt;</span>
</span><span class="line"><span class="x">        &lt;/div&gt;</span>
</span><span class="line"><span class="x">        &lt;p class=&quot;well&quot;&gt;</span><span class="cp">{{</span> <span class="nv">post.body</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
</span><span class="line"><span class="x">    &lt;/div&gt;</span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endverbatim</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x">&lt;/div&gt;</span>
</span><span class="line"><span class="x">&lt;script src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s2">&quot;underscore/underscore.js&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="x">&lt;script src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s2">&quot;angular/angular.js&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="x">&lt;script src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s2">&quot;angular-resource/angular-resource.js&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="x">&lt;script src=&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s2">&quot;js/script.js&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="x">&lt;/body&gt;</span>
</span><span class="line"><span class="x">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Теперь, давайте дополним шаблон простым контроллером, который будет возвращать список постов. Сейчас мы жестко пропишем посты, а потом будем получать их через AJAX.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;example.app.static&#39;</span><span class="p">,</span> <span class="p">[]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="s">&#39;AppController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span> <span class="s">&#39;$http&#39;</span><span class="p">,</span> <span class="nf">($scope, $http) -&gt;</span>
</span><span class="line">    <span class="nv">$scope.posts = </span><span class="p">[</span>
</span><span class="line">        <span class="nv">author:</span>
</span><span class="line">            <span class="nv">username: </span><span class="s">&#39;Joe&#39;</span>
</span><span class="line">        <span class="nv">title: </span><span class="s">&#39;Sample Post #1&#39;</span>
</span><span class="line">        <span class="nv">body: </span><span class="s">&#39;This is the first sample post&#39;</span>
</span><span class="line">    <span class="p">,</span>
</span><span class="line">        <span class="nv">author:</span>
</span><span class="line">            <span class="nv">username: </span><span class="s">&#39;Karen&#39;</span>
</span><span class="line">        <span class="nv">title: </span><span class="s">&#39;Sample Post #2&#39;</span>
</span><span class="line">        <span class="nv">body: </span><span class="s">&#39;This is another sample post&#39;</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Если вы установили все зависимости и запустили <code>grunt</code>, что бы скомпилить CoffeScript в JavaScript, то вы должны увидеть наш шаблон с прописанными в коде данными вроде этого:</p>

<p><img class="center" src="http://toly.github.io/images/DRF_Angular/example_static.png" /></p>

<h2 id="xhr-----api">Используем XHR для получения постов из API</h2>

<p>Теперь, давайте продолжим и обновим контроллер, чтобы получать список постов из нашего API. Сервис <code>$http</code> в AngularJS похож на <code>$.ajax</code> из jQuery или иную реализацию XHR. Обратите внимание, что с AngularJS мы просто обновили нашу модель (<code>$scope.posts</code>) результатом AJAX-запроса и наше представление автоматически обновляется по завершении AJAX-запроса. Нет необходимости изменять DOM. Такой реактивный подход позволяет нам разрабатывать сложные пользовательские интерфейсы с использованием взаимозависимостей данных нашей модели и компонентами пользовательского интерфейса, которые реагируют соответствующим образом без необходимости прямого управления этими связями, что позволяет сделать представления и модель данных слабосвязанными между собой.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;example.app.basic&#39;</span><span class="p">,</span> <span class="p">[]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="s">&#39;AppController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span> <span class="s">&#39;$http&#39;</span><span class="p">,</span> <span class="nf">($scope, $http) -&gt;</span>
</span><span class="line">    <span class="nv">$scope.posts = </span><span class="p">[]</span>
</span><span class="line">    <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;/api/posts&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(result) -&gt;</span>
</span><span class="line">        <span class="nx">angular</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(item) -&gt;</span>
</span><span class="line">            <span class="nx">$scope</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>С сервисом <code>$http</code>, получающим список постов из нашего API, наша тестовая страница покажет список постов прямо с сервера.</p>

<p><img class="center" src="http://toly.github.io/images/DRF_Angular/example_basic.png" /></p>

<h2 id="angular-resource--api">Используем Angular-Resource для API</h2>

<p>Хотя <code>$http</code> и позволяет с помощью XHR-запросов получать данные API для нашего приложения, это вынуждает нас дублировать код с учетом деталей нашего API, в том числе формирование URL’ов, осуществление запросов и другие вещи, которые можно реализовать на более высоком уровне абстракции. Используйте Angular-Resource, который предоставляет механизм для определения вашего API через сервисы Angular, управляющие большей частью низкоуровневых процессов, тем самым упрощая взаимодействие с API.</p>

<p>Для работы с Angular-Resource (ngResource), вы просто определяете связь между сущностями вашего API и параметрами в шаблоне URL-адреса (так же как и джанговсие urlpatterns). К сожелению, не так уж просто связать Django и определения ngResource, поэтому прицип DRY здесь неприменим.</p>

<p>При определении ваших ресурсов (используя $resource), вы просто предоставляете шаблон URL-адреса, список фигурируемых параметров по умолчанию и, при необходимости, некоторые HTTP методы. В нашем случае, нам нужен ресурс для модели <code>User</code>, который бы связывал имя пользователя (<code>:username</code>) в качестве параметра в URL-запросе и поле <code>username</code> из экземпляра ресурса. Сущности <code>Post</code> и <code>Photo</code> используют поле <code>id</code> экземпляра, т.к. оно является первичным ключом (идентификатором).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;example.api&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;ngResource&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">factory</span> <span class="s">&#39;User&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$resource&#39;</span><span class="p">,</span> <span class="nf">($resource) -&gt;</span>
</span><span class="line">    <span class="nx">$resource</span> <span class="s">&#39;/api/users/:username&#39;</span><span class="p">,</span> <span class="nv">username: </span><span class="s">&#39;@username&#39;</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">factory</span> <span class="s">&#39;Post&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$resource&#39;</span><span class="p">,</span> <span class="nf">($resource) -&gt;</span>
</span><span class="line">    <span class="nx">$resource</span> <span class="s">&#39;/api/posts/:id&#39;</span><span class="p">,</span> <span class="nv">id: </span><span class="s">&#39;@id&#39;</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">factory</span> <span class="s">&#39;Photo&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$resource&#39;</span><span class="p">,</span> <span class="nf">($resource) -&gt;</span>
</span><span class="line">    <span class="nx">$resource</span> <span class="s">&#39;/api/photos/:id&#39;</span><span class="p">,</span> <span class="nv">id: </span><span class="s">&#39;@id&#39;</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Теперь, когда мы определили наш модуль с API, мы можем использовать его в качестве зависимости в нашем модуле контроллера и применить его как сервис, который наш контроллер сможет использовать для доступа к API. Добавим <code>example.api</code> как зависимый модуль и список любых ресурсов API в качестве зависимостей в нашем поределении контроллера. По умолчанию, ваши ресурсы имеют множество основных CRUD методов, включая <code>query()</code> (для получения набора/списка объектов), <code>get()</code> (для получения отдельных объектов), <code>save()</code>, <code>delete()</code> и другие.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;example.app.resource&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;example.api&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="s">&#39;AppController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span> <span class="s">&#39;Post&#39;</span><span class="p">,</span> <span class="nf">($scope, Post) -&gt;</span>
</span><span class="line">    <span class="nv">$scope.posts = </span><span class="nx">Post</span><span class="p">.</span><span class="nx">query</span><span class="p">()</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>В результате получим такой же список постов, как и в примере выше.</p>

<p><img class="center" src="http://toly.github.io/images/DRF_Angular/example_resource.png" /></p>

<h2 id="section-2">Добавляем фотографии в список постов</h2>

<p>Теперь у нас есть список постов, показываемый с помощью вызовов ngResource API, но мы выполняем только получение данных. В реальных приложениях, ваши данные редко хранятся лишь в одной сущности API и может потребоваться несколько скоординированных запросов для построения актуальных данных модели. Давайте улучшим наше приложения, чтобы получать также фоторгафии каждого поста и выводить их.</p>

<p>Сначала давайте добавим два дополнительных ресурсы для вложенных вызовов API:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">factory</span> <span class="s">&#39;UserPost&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$resource&#39;</span><span class="p">,</span> <span class="nf">($resource) -&gt;</span>
</span><span class="line">    <span class="nx">$resource</span> <span class="s">&#39;/api/users/:username/posts/:id&#39;</span>
</span><span class="line"><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">factory</span> <span class="s">&#39;PostPhoto&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$resource&#39;</span><span class="p">,</span> <span class="nf">($resource) -&gt;</span>
</span><span class="line">    <span class="nx">$resource</span> <span class="s">&#39;/api/posts/:post_id/photos/:id&#39;</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Это создаст два дополнительных сервиса (<code>UserPost</code> и <code>UserPhoto</code>) которые мы можем использовать для получения ресурсов связанных с определенным пользователем и определенным постом соответственно. Так как это вложенные ресурсы, нам нужно что бы они загружались после основного ресурса (другой вариант заключается в использовании механизма <code>$watch</code> в Angular в ответ на изменения и выполнять дополнительные запросы к API). Для этого мы будем использовать сервис <code>$q</code> в Angular, который обеспечивает обещано-отложенную реализацию, позволяющую создавать цепочки вызовов. Начиная с версии 1.1 ngResource предоставляет аттрибут $promise, который вы можете применить для создания цепочки вызовов. Мы используем этот интерфейс, что бы после запроса к API следовало получение фотографий для полученного поста.</p>

<p>У вас есть несколько вариантов, как работать с вложенными ресурсами. Для этого случая, мы просто создадим еще один контейнер в <code>$scope</code> для фотографий и используем <code>post_id</code> в качестве идентификатора. Выражения в Angular и в его языке шаблонов игорируют отсутствующие ключи, поэтому мы просто проитерируем <code>photos[post.id]</code> чтобы получить фотографии в шаблоне. Обратите внимание, что нам не нужно что-либо делать, чтобы обновить представление или шаблон. Ангуляровский процесс <code>$digest</code> самостоятельно обноруживает обновления.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;example.app.photos&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;example.api&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="s">&#39;AppController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span> <span class="s">&#39;Post&#39;</span><span class="p">,</span> <span class="s">&#39;PostPhoto&#39;</span><span class="p">,</span> <span class="nf">($scope, Post, PostPhoto) -&gt;</span>
</span><span class="line">    <span class="nv">$scope.photos = </span><span class="p">{}</span>
</span><span class="line">    <span class="nv">$scope.posts = </span><span class="nx">Post</span><span class="p">.</span><span class="nx">query</span><span class="p">()</span>
</span><span class="line">    <span class="nx">$scope</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">$promise</span><span class="p">.</span><span class="nx">then</span> <span class="nf">(results) -&gt;</span>
</span><span class="line">        <span class="c1"># Load the photos</span>
</span><span class="line">        <span class="nx">angular</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">results</span><span class="p">,</span> <span class="nf">(post) -&gt;</span>
</span><span class="line">            <span class="nx">$scope</span><span class="p">.</span><span class="nx">photos</span><span class="p">[</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">PostPhoto</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nv">post_id: </span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Также обновим наш шаблон чтобы итерировать каждую модель поста для отображения фотографий каждого поста. Обратите внимание, как AngularJS повторно обновляет представление по мере того, как данные загружаются из API. В этом случае, мы итерируем фотографии объекта, ссылающиеся на идентификаторы постов, которые в свою очередь итерируются директивой <code>ng-repeat</code>. Мы также используем директиву <code>ng-src</code> вместо аттрибута <code>src</code>, так как это не позволяет браузеру загружать картинку до того как выражение Angular было прекомпилировано (тогда бы вы увидели ошибку 404 в ваших логах о невозможности показа ‘/media/{{ photo.image }}’).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;panel&quot;</span> <span class="na">ng-repeat=</span><span class="s">&quot;post in posts&quot;</span><span class="nt">&gt;</span>
</span><span class="line">    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;panel-heading clearfix&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">&quot;pull-left panel-title&quot;</span><span class="nt">&gt;</span>{{ post.title }}<span class="nt">&lt;/h3&gt;</span>
</span><span class="line">        <span class="nt">&lt;author</span> <span class="na">class=</span><span class="s">&quot;pull-right&quot;</span><span class="nt">&gt;</span>{{ post.author.username }}<span class="nt">&lt;/author&gt;</span>
</span><span class="line">    <span class="nt">&lt;/div&gt;</span>
</span><span class="line">    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;well&quot;</span><span class="nt">&gt;</span>{{ post.body }}<span class="nt">&lt;/p&gt;</span>
</span><span class="line">    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;photo&quot;</span> <span class="na">ng-repeat=</span><span class="s">&quot;photo in photos[post.id]&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;img</span> <span class="na">class=</span><span class="s">&quot;img-thumbnail&quot;</span> <span class="na">ng-src=</span><span class="s">&quot;{{ photo.image }}&quot;</span><span class="nt">&gt;</span>
</span><span class="line">    <span class="nt">&lt;/div&gt;</span>
</span><span class="line"><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>И в итоге, обновив страницу <a href="http://localhost:8000/photos">http://localhost:8000/photos</a>, получим отрендеренные фотографии:</p>

<p><img class="center" src="http://toly.github.io/images/DRF_Angular/example_photos.png" /></p>

<h2 id="angularjs----csrf">Лирическое отступление: AngularJS и защита от CSRF</h2>

<p>Django Rest Framework расширяет джанговскую защиту от <a href="http://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D0%B4%D0%B4%D0%B5%D0%BB%D0%BA%D0%B0_%D0%BC%D0%B5%D0%B6%D1%81%D0%B0%D0%B9%D1%82%D0%BE%D0%B2%D1%8B%D1%85_%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%B2">CSRF</a> (Cross Site Request Forgery) используя класс <code>SessionAuthentication</code> (как например в нашем случае: используется таже сессия браузера, что и для веб-приложения). Это способствует тому, что вредоносные сценарии не смогут использовать наших пользователей для выполнения различных запросов к нашему API, заставляя сценарии при каждом запросе отправлять генерируемый сервером токен. Модульная архитектура AngularJS и внедрение зависимостей позволяет сделать это простым конфигурированием запросов к API с помощью включения CSRF-токена в заголовок запроса (по желанию, можно также использовать куки).</p>

<p>В нашем джанговском шаблоне, просто добавьте тег <code>&lt;script&gt;</code> для конфигурирования сервиса <code>$http</code> и настройте джанговское приложение, что бы шаблонная переменная <code>{{ csrf_token }}</code> передавалась в заголовок ответа для всех вызовов API.</p>

<blockquote>
  <p>Будьте уверены, что этот скрипт загружается <strong>после</strong> определений модуля.</p>
</blockquote>

<blockquote>
  <p>Вы можете передавать CSRF токен между Angular и Django через куки или другим способом. Этот явный механизм с использованием заголовков просто обеспечивает генерацию CSRF токена при каждом запросе.</p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;script&gt;</span>
</span><span class="line"><span class="c1">// Add the CSRF Token</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;example.app&#39;</span><span class="p">);</span> <span class="c1">// Not including a list of dependent modules (2nd parameter to `module`) &quot;re-opens&quot; the module for additional configuration</span>
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">([</span><span class="s1">&#39;$httpProvider&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$httpProvider</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">$httpProvider</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span><span class="p">[</span><span class="s1">&#39;X-CSRFToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;{{ csrf_token|escapejs }}&#39;</span><span class="p">;</span>
</span><span class="line"><span class="p">}]);</span>
</span><span class="line"><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="api---angularjs">Создание и модификация ресурсов API с использованием AngularJS</h2>

<p>Теперь давайте сделаем редактор в нашем представлении ленты для публикации новых постов (такой как обновление статуса в Фейсбуке). Хотя большинство руководств по Angular просто добавляют функциональность к уже существующему контроллеру, я хочу показать как сохранить ваши контроллеры компактными и модульными, поэтому для этого редактора постов мы сделаем отдельный контроллер и покажем, как контроллеры используют вложенные области видимости для расширения функциональности. Это также дает возможность расширить существующий можуль <code>example.app.photos</code>, реализующий основной контроллер <code>AppController</code> для ленты постов.</p>

<p>Сперва, нам нужно расшарить наш базовый шаблон, и добавить html шаблон для редактора. Мы также добавим CSRF токен, согласно приведенным выше инструкциям, так как для создания новых постов будут использоваться потенциально уязвимые методы.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
</pre></td><td class="code"><pre><code class="django"><span class="line"><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;base.html&#39;</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line">
</span><span class="line"><span class="cp">{%</span> <span class="k">block</span> <span class="nv">ng_app</span> <span class="cp">%}</span><span class="x">example.app.editor</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line">
</span><span class="line"><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">verbatim</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="x">&lt;div ng-controller=&quot;EditController&quot;&gt;</span>
</span><span class="line"><span class="x">    &lt;h5&gt;Create a New Post&lt;/h5&gt;</span>
</span><span class="line"><span class="x">    &lt;form class=&quot;form-inline&quot;&gt;</span>
</span><span class="line"><span class="x">        &lt;div class=&quot;form-group block-level&quot;&gt;</span>
</span><span class="line"><span class="x">            &lt;input type=&quot;text&quot; class=&quot;form-control&quot; ng-model=&quot;newPost.title&quot; placeholder=&quot;Title&quot;&gt;</span>
</span><span class="line"><span class="x">        &lt;/div&gt;</span>
</span><span class="line"><span class="x">        &lt;div class=&quot;form-group&quot;&gt;</span>
</span><span class="line"><span class="x">            &lt;input type=&quot;text&quot; class=&quot;form-control&quot; ng-model=&quot;newPost.body&quot; placeholder=&quot;Body&quot;&gt;</span>
</span><span class="line"><span class="x">        &lt;/div&gt;</span>
</span><span class="line"><span class="x">        &lt;div class=&quot;form-group&quot;&gt;</span>
</span><span class="line"><span class="x">            &lt;button class=&quot;btn btn-default&quot; ng-click=&quot;save()&quot;&gt;Add Post&lt;/button&gt;</span>
</span><span class="line"><span class="x">        &lt;/div&gt;</span>
</span><span class="line"><span class="x">    &lt;/form&gt;</span>
</span><span class="line"><span class="x">&lt;/div&gt;</span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endverbatim</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{{</span> <span class="nb">block</span><span class="nv">.super</span> <span class="cp">}}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line">
</span><span class="line"><span class="cp">{%</span> <span class="k">block</span> <span class="nv">js</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{{</span> <span class="nb">block</span><span class="nv">.super</span> <span class="cp">}}</span><span class="x"></span>
</span><span class="line"><span class="x">&lt;script&gt;</span>
</span><span class="line"><span class="x">// Add the CSRF Token</span>
</span><span class="line"><span class="x">var app = angular.module(&#39;example.app.editor&#39;); // Not including a list of dependent modules (2nd parameter to `module`) &quot;re-opens&quot; the module for additional configuration</span>
</span><span class="line"><span class="x">app.config([&#39;$httpProvider&#39;, function($httpProvider) {</span>
</span><span class="line"><span class="x">    $httpProvider.defaults.headers.common[&#39;X-CSRFToken&#39;] = &#39;</span><span class="cp">{{</span> <span class="nv">csrf_token</span><span class="o">|</span><span class="nf">escapejs</span> <span class="cp">}}</span><span class="x">&#39;;</span>
</span><span class="line"><span class="x">}]);</span>
</span><span class="line"><span class="x">&lt;/script&gt;</span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Теперь, у нас есть редактор - давайте сделаем контроллер для его подключения. Заметьте, что теперь у нас в зависимостях два модуля: базовый модуль нашей ленты постов и модуль API, содержащий все определения ресурсов API (<code>$resource</code>).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;example.app.editor&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;example.api&#39;</span><span class="p">,</span> <span class="s">&#39;example.app.photos&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="s">&#39;EditController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span> <span class="s">&#39;Post&#39;</span><span class="p">,</span> <span class="nf">($scope, Post) -&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nv">$scope.newPost = </span><span class="k">new</span> <span class="nx">Post</span><span class="p">()</span>
</span><span class="line">    <span class="nv">$scope.save = </span><span class="nf">-&gt;</span>
</span><span class="line">        <span class="nx">$scope</span><span class="p">.</span><span class="nx">newPost</span><span class="p">.</span><span class="nx">$save</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(result) -&gt;</span>
</span><span class="line">            <span class="nx">$scope</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">result</span>
</span><span class="line">        <span class="p">.</span><span class="nx">then</span> <span class="nf">-&gt;</span>
</span><span class="line">            <span class="c1"># Reset our editor to a new blank post</span>
</span><span class="line">            <span class="nv">$scope.newPost = </span><span class="k">new</span> <span class="nx">Post</span><span class="p">()</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Ранее, в представлениях API, мы добавляли некоторые ограничения прав доступа, чтобы предотвратить изменения пользователями чужих постов. До сих пор это не имело значения, какое отношение имеет пользователь к редактируемому посту. Но теперь, когда мы хотим создать пользователей, мы должны гарантировать, что обрабатываем запрос от пользователя, который имеет право на этот запрос (иначе, запрос на создание нового поста должен быть отклонен). В этом учебном примере, мы использовали хак аутентификации Django, который автоматически авторизует вас как пользователя <code>root</code>. Разумеется, в продакшене или ином недоверенном окружении так делать нельзя. Это сделано для упрощения демонстрации тестового приложения, игнорируя регистрацию и авторизацию пользователя.</p>

<p><img class="center" src="http://toly.github.io/images/DRF_Angular/example_editor.png" /></p>

<h2 id="section-3">Обработка ошибок</h2>

<p>Если вы тестировали получившееся приложение, пробовали ли вы создать пост без заголовка? Мы определили обязательные поля в модели Django, и Django Rest Framework будет проверять их наличие при создании нового поста. Если вы попытаетесь создать пост без заголовка (например, с помощью браузерного API или наше новой формы), вы получите 400-ю ошибку, с описанием причин ошибочности запроса. Давайте использовать этот ответ для информировнаия пользователя.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="json"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class="line">        <span class="s2">&quot;This field is required.&quot;</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Для информирования пользователя, давайте изменим вызов API. Так как мы используем <code>Promises</code>, мы можем просто добавить коллбек-функцию, вызываемую при ошибке, чтобы получить информацию в ответе и уведомить пользователя, передав ответ в <code>$scope</code>, откуда шаблон сможет вывести ошибку для показа пользователю.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;example.app.editor&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;example.api&#39;</span><span class="p">,</span> <span class="s">&#39;example.app.photos&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="s">&#39;EditController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span> <span class="s">&#39;Post&#39;</span><span class="p">,</span> <span class="nf">($scope, Post) -&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nv">$scope.newPost = </span><span class="k">new</span> <span class="nx">Post</span><span class="p">()</span>
</span><span class="line">    <span class="nv">$scope.save = </span><span class="nf">-&gt;</span>
</span><span class="line">        <span class="nx">$scope</span><span class="p">.</span><span class="nx">newPost</span><span class="p">.</span><span class="nx">$save</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(result) -&gt;</span>
</span><span class="line">            <span class="nx">$scope</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">result</span>
</span><span class="line">        <span class="p">.</span><span class="nx">then</span> <span class="nf">-&gt;</span>
</span><span class="line">            <span class="c1"># Reset our editor to a new blank post</span>
</span><span class="line">            <span class="nv">$scope.newPost = </span><span class="k">new</span> <span class="nx">Post</span><span class="p">()</span>
</span><span class="line">        <span class="p">.</span><span class="nx">then</span> <span class="nf">-&gt;</span>
</span><span class="line">            <span class="c1"># Clear any errors</span>
</span><span class="line">            <span class="nv">$scope.errors = </span><span class="kc">null</span>
</span><span class="line">        <span class="p">,</span> <span class="nf">(rejection) -&gt;</span>
</span><span class="line">            <span class="nv">$scope.errors = </span><span class="nx">rejection</span><span class="p">.</span><span class="nx">data</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Также обновим шаблон, для вывода информации об ошибках:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;p</span> <span class="na">ng-repeat=</span><span class="s">&quot;(name, errs) in errors&quot;</span> <span class="na">class=</span><span class="s">&quot;alert alert-danger&quot;</span><span class="nt">&gt;&lt;strong&gt;</span>{{ name }}<span class="nt">&lt;/strong&gt;</span>: {{ errs.join(&#39;, &#39;) }}<span class="nt">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Подобным образом довольно просто к элементам пользовательского интерфейса добавить получение обратной связи о прогрессе (индиваторы загрузки, прогресс-бары) используя цепочечные вызовы. В AngularJS есть достаточно полная обработка ошибок через цепочки вызовов, делающая обработку ошибок простой.</p>

<p>В этом демонстрационном примере, мы просто перечислили ошибки и вывели их в специально оформленных элементах интерфейса. Так как ошибки имеют привязку к имени аттрибута, вы легко можете показать список ошибок возле того элемента формы, которому они соответсвуют.</p>

<p><img class="center" src="http://toly.github.io/images/DRF_Angular/example_error.png" /></p>

<h2 id="section-4">Удаление своих постов</h2>

<p>Чтобы редактор был полным, нам нужен способ удалять любые посты, но только те, которые добавлены текущим пользователем. У нас уже есть API, которое предотвращает попытки удаления/изменения ресурсов пользователями, которые не владеют ими. Если вы только начали изучать AngularJS, то вам сложно понять, как с помощью его модульной архитектуры обеспечить наличие начальных данных в контроллере. В нашем случае, зная текущего пользователя, можно определить какие посты доступны ему для удаления.</p>

<p>Ключ к пониманию этого заключается в попытке разложить функционал контроллеров на несколько служб, выполняющих определенную часть логики. Контроллер (тоже, что и представление в Django) должны только обеспечить слаженную работу различных компонентов. В Django, вы пытаетесь разместить как можно боьше бизнес-логики в модели (паттерн “толстые модели”). В AngularJS, вы похожим образом распределяете бизнес-логику в компонуемых службах.</p>

<p>Чтобы добавить возможность удалять посты, давайте сначала добавим модуль, расширяющий наш редактор, и добавим дополнительный контроллер для обрабтки удаления. В зависимостях нового контроллера будет служба <code>AuthUser</code>, которая через джанговский шаблон будет предоставлять текущего пользователя. В этом случае, служба будет содержать один аттрибут <code>username</code>, в котором будет имя текущего пользователя (или пустая строка, если пользователя нет). Мы добавили две функции в область видимости нового контроллера: <code>canDelete</code>, чтобы определить может ли текущий пользователь удалить пост, и <code>delete</code>, чтобы удалять пост. Обе функции принимают аргумент <code>post</code>, который передается туда через шаблон.</p>

<p>Опять же, мы использовали цепочечный вызов службы <code>$resource</code>, и только успешного подтверждения со стороны сервера об удалении поста, мы обновляем список постов. Так же как и было указано выше, есть возможность обработки ошибок выполнения запроса и обеспечения обратной связи с пользователем, но в нашем простом примере мы это пропустим.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line"><span class="nv">app = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;example.app.manage&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;example.api&#39;</span><span class="p">,</span> <span class="s">&#39;example.app.editor&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="s">&#39;DeleteController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;$scope&#39;</span><span class="p">,</span> <span class="s">&#39;AuthUser&#39;</span><span class="p">,</span> <span class="nf">($scope, AuthUser) -&gt;</span>
</span><span class="line">    <span class="nv">$scope.canDelete = </span><span class="nf">(post) -&gt;</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">post</span><span class="p">.</span><span class="nx">author</span><span class="p">.</span><span class="nx">username</span> <span class="o">==</span> <span class="nx">AuthUser</span><span class="p">.</span><span class="nx">username</span>
</span><span class="line">
</span><span class="line">    <span class="nv">$scope.delete = </span><span class="nf">(post) -&gt;</span>
</span><span class="line">        <span class="nx">post</span><span class="p">.</span><span class="nx">$delete</span><span class="p">()</span>
</span><span class="line">        <span class="p">.</span><span class="nx">then</span> <span class="nf">-&gt;</span>
</span><span class="line">            <span class="c1"># Remove it from the list on success</span>
</span><span class="line">            <span class="nv">idx = </span><span class="nx">$scope</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span>
</span><span class="line">            <span class="nx">$scope</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>После определения контроллера, давайте обновим наш шаблон поста и добавим кнопку удаления (при условии, что функция <code>canDelete</code> возвращает <code>true</code>).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="django"><span class="line"><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;editor.html&#39;</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line">
</span><span class="line"><span class="cp">{%</span> <span class="k">block</span> <span class="nv">ng_app</span> <span class="cp">%}</span><span class="x">example.app.manage</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line">
</span><span class="line"><span class="cp">{%</span> <span class="k">block</span> <span class="nv">post_header</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line">
</span><span class="line"><span class="x">&lt;button type=&quot;button&quot; class=&quot;close&quot; ng-controller=&quot;DeleteController&quot; ng-click=&quot;delete(post)&quot; ng-show=&quot;canDelete(post)&quot;&gt;&amp;times;&lt;/button&gt;</span>
</span><span class="line"><span class="cp">{{</span> <span class="nb">block</span><span class="nv">.super</span> <span class="cp">}}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line">
</span><span class="line"><span class="cp">{%</span> <span class="k">block</span> <span class="nv">js</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{{</span> <span class="nb">block</span><span class="nv">.super</span> <span class="cp">}}</span><span class="x"></span>
</span><span class="line"><span class="x">&lt;script&gt;</span>
</span><span class="line"><span class="x">// Configure the current user</span>
</span><span class="line"><span class="x">var app = angular.module(&#39;example.app.manage&#39;); // Not including a list of dependent modules (2nd parameter to `module`) &quot;re-opens&quot; the module for </span>
</span><span class="line">
</span><span class="line"><span class="x">app.factory(&#39;AuthUser&#39;, function() {</span>
</span><span class="line"><span class="x">    return {</span>
</span><span class="line"><span class="x">        username: &quot;</span><span class="cp">{{</span> <span class="nv">user.username</span><span class="o">|</span><span class="nf">default</span><span class="s1">:&#39;&#39;</span><span class="o">|</span><span class="nf">escapejs</span> <span class="cp">}}</span><span class="x">&quot;</span>
</span><span class="line"><span class="x">    }</span>
</span><span class="line"><span class="x">});</span>
</span><span class="line"><span class="x">&lt;/script&gt;</span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>И когда вы загрузите <a href="http://localhost:8000/manage">http://localhost:8000/manage</a>, возле постов с автором <code>root</code> будет кнопка <strong>‘X’</strong>, а возле поста с автором <code>bob</code> - не будет. При нажатии на кнопку <strong>‘X’</strong> наш API удалит пост.</p>

<p><img class="center" src="http://toly.github.io/images/DRF_Angular/example_managed.png" /></p>

<p>Итак, у нас есть простая лента, в которой пользователи могут размещать посты.</p>

<h2 id="section-5">Заключение</h2>

<p>Хорошо, давайте подумаем. Небольшим количеством кода (примерно 100 строк в интерфейсной части, и 200 строк в серверной), используя Django Rest Framework (ну и Django) и AngularJS, мы смогли быстро написать пример приложения для простой публикации постов. Django Rest Framework позволяет легко экспортировать данные наших джанговских моделей через RESTful API с возможностью настройки выводных данных в зависимости от наших нужд. AngularJS облегчает получение данных и взаимодейтсвие с API, причем делает это модульно и структурированно, что помогает нам добавлять новый функционал для наших приложений без спагетти-кода.</p>

<p>Весь код, упоминавшийся в этой статье, доступен на <a href="https://github.com/kevinastone/django-api-rest-and-angular">гитхабе</a>. Я советую скачать этот репозиторий и установить рабочую копию проекта для экспериментов. Если заметите какие-либо ошибки - поставьте таск в гитхабе (или даже пулл-реквест). Если есть какие-либо вопросы - оставьте комментарий (или стукнитесь в твиттер <a href="https://twitter.com/kevinastone">@kevinastone</a>). Я планируюю дополнить эту статью дополнительными случаями, с которыми мне приходилось сталкиваться, а именно:</p>

<ul>
  <li>пагинация</li>
  <li>API переключатели (типа подписаться/отписаться)</li>
  <li>более сложные права доступа</li>
  <li>расширенная валидация</li>
  <li>тестирование</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Руководство: Используем AngularJS с Django]]></title>
    <link href="http://toly.github.io/blog/2014/03/08/tutorial-using-angularjs-with-django/"/>
    <updated>2014-03-08T20:04:27+04:00</updated>
    <id>http://toly.github.io/blog/2014/03/08/tutorial-using-angularjs-with-django</id>
    <content type="html"><![CDATA[<blockquote>
  <p>Перевод статьи Глена Джексона <a href="http://glynjackson.org/weblog/entry/django-angular.html">Tutorial: Using AngularJS with Django</a></p>
</blockquote>

<p>~~Я надеялся написать быстрое руководство, что бы вы начали использовать Angular с Django~~ которое становилось руководством по поглощению Red Bull. Мои извинения, если оно получится небрежным к концу!</p>

<p>Почитав посты на тему совместного использования Django и AngularJS, я чувтсвовал, что большинство из них были “велосипедными”. Хотя пример кода, который здесь приводится, сырой, он должен показать, как я использую их в проектах.</p>

<!-- more -->

<h2 id="section">Модели</h2>

<p>Давайте начнем с типичной модели</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/jobs/models.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">Job</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span class="line">    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Ок, пока ничего особенного. Все что вы сделали - это создали простую модель, которая содержит основные сведения о работе.</p>

<h2 id="rest-api-tastypie">REST API (Tastypie)</h2>

<p>AngularJS построен так, что бы использовать веб-сервисы, поэтому вам нужен способ плучать данные только что созданной модели <code>Job</code>.</p>

<p>Для Django есть хороший выбор вариантов для создания RESTful API. <em>TastyPie</em> является отличным REST фреймворком для Django. Он невероятно мощный, но простой в установке и использовании. Однако, по-моему, таких же результатов можно добиться используя <em>Django REST framework</em>, или даже самостоятельно создав ответы на запросы API средствами Django. Выбор остается за вами. В этом уроке мы будем использовать <em>TastyPie</em>.</p>

<p>Если вам не знаком <em>TastyPie</em>, ознакомьтесь с <a href="http://django-tastypie.readthedocs.org/en/latest/">документацией</a>. Я не буду вдаваться в подробности относительно установки. И предполагаю, он уже установлен, добавлен в <code>INSTALLED_APPS</code> и вы готовы продолжить.</p>

<p>Сперва, вам нужно создать ресурс для модели <code>Job</code>. <em>TastyPie</em> использует понятие <em>ресурс</em>. Это описывается как посредник между конечным пользователем и объектом (в данном случае это будет модель <code>Job</code>).</p>

<p>Начните с создания соответствующего ресурса для модели <code>Job</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">tastypie.resources</span> <span class="kn">import</span> <span class="n">ModelResource</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">tastypie.authentication</span> <span class="kn">import</span> <span class="n">Authentication</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">tastypie.authorization</span> <span class="kn">import</span> <span class="n">Authorization</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Job</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">JobResource</span><span class="p">(</span><span class="n">ModelResource</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;</span>
</span><span class="line"><span class="sd">    API Facet</span>
</span><span class="line"><span class="sd">    &quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span><span class="line">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Job</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line">        <span class="n">resource_name</span> <span class="o">=</span> <span class="s">&#39;job&#39;</span>
</span><span class="line">        <span class="n">allowed_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;post&#39;</span><span class="p">,</span> <span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;patch&#39;</span><span class="p">,</span> <span class="s">&#39;delete&#39;</span><span class="p">]</span>
</span><span class="line">        <span class="n">authentication</span> <span class="o">=</span> <span class="n">Authentication</span><span class="p">()</span>
</span><span class="line">        <span class="n">authorization</span> <span class="o">=</span> <span class="n">Authorization</span><span class="p">()</span>
</span><span class="line">        <span class="n">always_return_data</span> <span class="o">=</span> <span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Насколько я помню, документация TastyPie предлагает назвать файл ресурсов как <em>api.py</em>. Так же предлагаю и я, но это не обязательно. Вы можете назвать этот файл как угодно, но это хорошо для сохранения постоянства.</p>

<p>Есть несколько вещей, происходящих в <code>JobResource</code>, которые выходят за рамки данного руковосдства. Но, я просто хотел бы обратить внимание на то, как <code>JobResource</code> наследует <code>ModelResource</code>. Вы используете TastyPie с ORM Django (модель <code>Job</code>). Другими словами, многие из основных API ORM вым доступны.</p>

<p>TastyPie так же может обрабатывать данные и без ORM. Расширяя и наследуя ресурс, вы так же можете получить все вкусности TastyPie для API которое захотите предложить, но без привязки к ORM. Это особенно полезно при совершении запросов, не поддерживающих ORM, NoSQL баз как описано в документации.</p>

<p>Пока что вы создали модель данных (<code>Job</code>) и способ взаимодействия с нею (<code>JobResource</code>). Далее, вам нужен способ подключения к ресурсу через определеный URL, что в конечном итоге позволит AnagularJS его использовать. В Django вы можете сделать это используя URL роутер. Просто подключите экземпляр ресурса к определенному URL:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">tastypie.api</span> <span class="kn">import</span> <span class="n">Api</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">.apps.your_app.api</span> <span class="kn">import</span> <span class="n">JobResource</span>
</span><span class="line">
</span><span class="line"><span class="n">v1_api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">api_name</span><span class="o">=</span><span class="s">&#39;v1&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">v1_api</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">JobResource</span><span class="p">())</span>
</span><span class="line">
</span><span class="line"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class="line">
</span><span class="line">     <span class="p">(</span><span class="s">r&#39;^api/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">v1_api</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Аттрибут <code>resource_name</code>, определенный в <code>JobResource</code> - это название ресурса в URL. По нему вы знаете где находится работающее API для ресурса <code>JobResource</code>. Проверьте что все это работает, запустив локальный сервер и посетив адрес <a href="http://127.0.0.1:8000/api/v1/job/?format=json">http://127.0.0.1:8000/api/v1/job/?format=json</a></p>

<p>Теперь у вас есть рабочее API для вашей модели <code>Job</code>. Просто.</p>

<h2 id="section-1">Формы</h2>

<p>Перед тем как начать использовать AngularJS нам нужно сделать форму для <code>Job</code> с использованием Django. Позже, эта форма позволит вам редактировать данные модели <code>Job</code> в одностраничном приложении. Я знаю о чем вы думаете: “Почему в Django”?</p>

<p>Одним из приципов в Django является прицип “на повторяйся” (DRY). Так что не имеет смысла создавать формы с помощью HTML для AngularJS, а затем делать то же для Django. К тому же Django хорошо справляется с соданием форм. Возможно у вас есть несколько форм, которые нужно преобразовать, так почему бы не сделать это автоматическим? Посмотрите в сторону <a href="http://django-angular.readthedocs.org/en/latest/">django-angular</a>. Это один классный пакет, познакомившись с которым вы будете рады (я знаю о чем говорю).</p>

<blockquote>
  <p><em>django-angular</em> - это набор утилит, которые помогают упростить интеграцию Django и AngularJS с помощью повторно используемых компонентов</p>
</blockquote>

<p>Опять же, здесь я не буду вдаваться в подробности относительно установки и настройки. Я предлагаю вам ознакомиться с документацией и начать использовать django-angular прямо сейчас! Достаточно сказать, что один из его многочисленных компонентов позволит вам использовать формы Django для валидации в AngularJS. Объединив его с пакетом <code>crispy forms</code> вы получите мощное решение “все-в-одном” - вот за что я люблю Django и его сообщество.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">djangular.forms</span> <span class="kn">import</span> <span class="n">NgFormValidationMixin</span><span class="p">,</span> <span class="n">NgModelFormMixin</span><span class="p">,</span> <span class="n">AddPlaceholderFormMixin</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">crispy_forms.helper</span> <span class="kn">import</span> <span class="n">FormHelper</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Job</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">JobForm</span><span class="p">(</span><span class="n">NgModelFormMixin</span><span class="p">,</span> <span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;</span>
</span><span class="line"><span class="sd">    Job Form with a little crispy forms added!</span>
</span><span class="line"><span class="sd">    &quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="nb">super</span><span class="p">(</span><span class="n">JobForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">        <span class="n">setup_bootstrap_helpers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span><span class="line">        <span class="n">model</span> <span class="o">=</span> <span class="n">Job</span>
</span><span class="line">        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;description&#39;</span><span class="p">,)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">setup_bootstrap_helpers</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="nb">object</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">FormHelper</span><span class="p">()</span>
</span><span class="line">    <span class="nb">object</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">form_class</span> <span class="o">=</span> <span class="s">&#39;form-horizontal&#39;</span>
</span><span class="line">    <span class="nb">object</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">label_class</span> <span class="o">=</span> <span class="s">&#39;col-lg-3&#39;</span>
</span><span class="line">    <span class="nb">object</span><span class="o">.</span><span class="n">helper</span><span class="o">.</span><span class="n">field_class</span> <span class="o">=</span> <span class="s">&#39;col-lg-8&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="angularjs">AngularJS</h2>

<p>Для простоты сделайте 3 новых шаблона, расположенных так:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">templates</span>
</span><span class="line">    <span class="n">jobs</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
</span><span class="line">    <span class="n">jobs</span><span class="o">/</span><span class="n">new</span><span class="o">.</span><span class="n">html</span>
</span><span class="line"><span class="n">base</span><span class="o">.</span><span class="n">html</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Это предполагает, что приложение <code>jobs</code> установлено и настроено. Базовый шаблон будет выглядеть примерно так:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/jobs/base.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="django"><span class="line"><span class="x">&lt;!DOCTYPE html&gt;</span>
</span><span class="line"><span class="x">&lt;html&gt;</span>
</span><span class="line"><span class="x">&lt;head&gt;</span>
</span><span class="line"><span class="x">    &lt;meta charset=&quot;utf-8&quot;&gt;</span>
</span><span class="line"><span class="x">    &lt;link href=&quot;//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.2/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span>
</span><span class="line">
</span><span class="line"><span class="x">    &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/angularjs/1.2.7/angular.js&quot;&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="x">    &lt;script src=&quot;/angular-ui-router.min.js&quot;&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="x">    &lt;script type=&quot;text/javascript&quot; src=&quot;http://cdn.jsdelivr.net/restangular/latest/restangular.js&quot;&gt;&lt;/script&gt;</span>
</span><span class="line">
</span><span class="line"><span class="x">&lt;/head&gt;</span>
</span><span class="line"><span class="x">&lt;body&gt;</span>
</span><span class="line"><span class="x">    </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="x">    </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">extra_javascript</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="nv">extra_javascript</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="x">&lt;/body&gt;</span>
</span><span class="line"><span class="x">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Django-angular предлагает полезные шаблонные теги, которые включат необходимый для вас JavaScript. Я рекомендую использовать CDN и загрузить туда файлы, какие можно. Это дает географические и пропускные преимущества.</p>

<p>Теперь создадим шаблон страницы, который будет рендерится нашим проектом. <em>index.html</em> будет служить главной страницей нашего одностраничного приложения, и позже может быть использован для всех CRUD (Create Read Update Delete) представлений.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/jobs/index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="django"><span class="line"><span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;base.html&quot;</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">load</span> <span class="nv">i18n</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="x">&lt;div class=&quot;container content&quot; ng-app=&quot;JobApp&quot;&gt;</span>
</span><span class="line"><span class="x">    &lt;div ui-view &gt;Loading...&lt;/div&gt;</span>
</span><span class="line"><span class="x">&lt;/div&gt;</span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">block</span> <span class="nv">extra_javascript</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="x">&lt;script src=&quot;</span><span class="cp">{{</span> <span class="nv">STATIC_URL</span> <span class="cp">}}</span><span class="x">/javascript/app.js&quot;&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">extra_javascript</span> <span class="cp">%}</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/javascript/app.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;JobApp&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span class="line">    <span class="s1">&#39;ui.router&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s1">&#39;restangular&#39;</span>
</span><span class="line"><span class="p">])</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$stateProvider</span><span class="p">,</span> <span class="nx">$urlRouterProvider</span><span class="p">,</span> <span class="nx">RestangularProvider</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="c1">// For any unmatched url, send to /route1</span>
</span><span class="line">    <span class="nx">$urlRouterProvider</span><span class="p">.</span><span class="nx">otherwise</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">);</span>
</span><span class="line">    <span class="nx">$stateProvider</span>
</span><span class="line">        <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">            <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
</span><span class="line">            <span class="nx">templateUrl</span><span class="o">:</span> <span class="s2">&quot;/static/html/partials/_job_list.html&quot;</span><span class="p">,</span>
</span><span class="line">            <span class="nx">controller</span><span class="o">:</span> <span class="s2">&quot;JobList&quot;</span>
</span><span class="line">        <span class="p">})</span>
</span><span class="line">
</span><span class="line">       <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">            <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/new&quot;</span><span class="p">,</span>
</span><span class="line">            <span class="nx">templateUrl</span><span class="o">:</span> <span class="s2">&quot;/jobs/job-form&quot;</span><span class="p">,</span>
</span><span class="line">            <span class="nx">controller</span><span class="o">:</span> <span class="s2">&quot;JobFormCtrl&quot;</span>
</span><span class="line">        <span class="p">})</span>
</span><span class="line"><span class="p">})</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s2">&quot;JobFormCtrl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="s1">&#39;Restangular&#39;</span><span class="p">,</span> <span class="s1">&#39;CbgenRestangular&#39;</span><span class="p">,</span> <span class="s1">&#39;$q&#39;</span><span class="p">,</span>
</span><span class="line"><span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">Restangular</span><span class="p">,</span> <span class="nx">CbgenRestangular</span><span class="p">,</span> <span class="nx">$q</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="p">}])</span><span class="c1">// end controller</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Шаблон и JS код выше очень простые, наследуется от базового шаблона. Есть несколько аттрибутов, которые вы возможно не видели прежде и в которых нужно будет разобраться.</p>

<p>Первый из них: <code>ng-app="JobApp"</code>. Без этого тега процесс AngularJS не запустится. Эта директива говорит фреймворку AngularJS какой элемент является корневым в приложении. Все, что вы добавите внутрь этого элемента будет частью шаблона под управлением AngularJS.</p>

<p>Далее, посмотрите на скрипт, который вы включили в <code>index.html</code>. Это скрипт <code>app.js</code>, который является модулем AngularJS. Модуль AngularJS представляет собой набор функций, которые выполняются когда приложение загружено.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;JobApp&#39;</span><span class="p">,</span> <span class="p">[</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Строка, расположенная выше, создает модуль <code>JobApp</code>. В index.html вы уже создали его экземпляр с помощью директивы <code>ng-app="JobApp"</code>. Основное, что здесь делается: сообщается AngularJS, что модуль <code>app.js</code> управляет содержимым этого тега.</p>

<p>Фактически, вы можете установить аттрибут <code>ng-app</code> для любого элемента в DOM. Например, если вы хотите, что бы часть шаблона не управлялась через Angular, вы можете сделать так:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="html"><span class="line"><span class="nt">&lt;h2&gt;</span>I am not inside an AngularJS app<span class="nt">&lt;/h2&gt;</span>
</span><span class="line"><span class="nt">&lt;div</span> <span class="na">ng-app=</span><span class="s">&quot;embeddedApp&quot;</span><span class="nt">&gt;</span>
</span><span class="line">  <span class="nt">&lt;h3&gt;</span>Inside an AngularJS app<span class="nt">&lt;/h3&gt;</span>
</span><span class="line"><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>app.config</code> в app.js также показывает начало вашей URL-маршрутизации. AngularJS поддерживает URL-маршрутизацию по умолчанию через сервис <code>$route</code> в ядре Angular, но этого недостаточно и это имеет некоторые ограничения.</p>

<p>Один из модулей, которые вы включили, это AngularUI роутер <code>ui.route</code>. AngularUI роутер - это дополнительный модуль URL-маршрутизации для Angular, организованный в контексте состояний, которые опционально могуть иметь прикрепленные реакции на определенные URL’ы.</p>

<p>В этом руководстве предусмотрено одно состояние, которое назыаается <code>new</code>, но вы можете определять много различных состояний для вашего приложения. Вы даже можете добавить поведение для того случая, когда ни одного состояния не обнаружено:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">$urlRouterProvider</span><span class="p">.</span><span class="nx">otherwise</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">);</span>
</span><span class="line"><span class="nx">$stateProvider</span>
</span><span class="line">   <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">       <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
</span><span class="line">       <span class="nx">templateUrl</span><span class="o">:</span> <span class="s2">&quot;static/html/somepage.html&quot;</span><span class="p">,</span>
</span><span class="line">       <span class="nx">controller</span><span class="o">:</span> <span class="s2">&quot;SomeController&quot;</span>
</span><span class="line">   <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Если вы не знакомы с этим, то я предлагаю почитать о <a href="https://github.com/angular-ui/ui-router">AngularUI Router</a> после того как закончите с этим руководством.</p>

<p>Последний элемент в index.html, с которым вам нужно разобраться - это <code>ui-view</code>. Это тоже относится к AngularUI Router. Директива <code>ui-view</code> определяет куда разместь ваш шаблон.</p>

<p>Последний шаблон, который нужно создать - <em>/jobs/new.html</em>. Он будет содержать простую форму, которую вы сделали ранее с использованием django-angular.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/jobs/new.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="django"><span class="line"><span class="cp">{%</span> <span class="k">load</span> <span class="nv">crispy_forms_tags</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="cp">{%</span> <span class="k">crispy</span> <span class="nv">JobForm</span> <span class="cp">%}</span><span class="x"></span>
</span><span class="line"><span class="x">&lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot;  ng-click=&quot;submitJob()&quot;&gt;Create&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Теперь вам нужно всего лишь представление и URL для подключения формы.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/jobs/views.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">JobForm</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">JobFormView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
</span><span class="line">    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&quot;jobs/new.html&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">JobFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">JobForm</span><span class="o">=</span><span class="n">JobForm</span><span class="p">())</span>
</span><span class="line">        <span class="k">return</span> <span class="n">context</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">IndexView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
</span><span class="line">    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;jobs/index.html&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/jobs/urls.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">JobFormView</span><span class="p">,</span> <span class="n">IndexView</span>
</span><span class="line">
</span><span class="line"><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class="line">
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^job-form/$&#39;</span><span class="p">,</span> <span class="n">login_required</span><span class="p">(</span><span class="n">JobFormView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;job_form&#39;</span><span class="p">),</span>
</span><span class="line">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^/$&#39;</span><span class="p">,</span> <span class="n">IndexView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;index_job&#39;</span><span class="p">),</span>
</span><span class="line">
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>Теперь отправьте ваш браузер по адресу <a href="http://127.0.0.1:8000/job/#new">http://127.0.0.1:8000/job/#new</a> и вы должны увидеть форму для добавления работы в вашем новом одностраничном приложении.</p>

<p>Последний шаг - сделать возможным отправку POST-данных при нажатии на кнопку с <code>ng-click="submitJob()"</code>. Измените контроллер как показано ниже, используя <a href="https://github.com/mgonto/restangular">restangular</a>.</p>

<blockquote>
  <p>RestAngular - это модуль для AngularJS упрощает работу с GET, DELETE и UPDATE запросами, используя минимум клентского кода. Он идеально подходит для любого веб приложения, которое получает данные через REST API.</p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s2">&quot;JobFormCtrl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="s1">&#39;Restangular&#39;</span><span class="p">,</span> <span class="s1">&#39;CbgenRestangular&#39;</span><span class="p">,</span> <span class="s1">&#39;$q&#39;</span><span class="p">,</span>
</span><span class="line"><span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">Restangular</span><span class="p">,</span> <span class="nx">CbgenRestangular</span><span class="p">,</span> <span class="nx">$q</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">    <span class="nx">$scope</span><span class="p">.</span><span class="nx">submitJob</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="kd">var</span> <span class="nx">post_update_data</span> <span class="o">=</span> <span class="nx">create_resource</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">CbgenRestangular</span><span class="p">);</span>
</span><span class="line">        <span class="nx">$q</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">post_update_data</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
</span><span class="line">            <span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">                <span class="c1">// success!</span>
</span><span class="line">            <span class="p">},</span>
</span><span class="line">
</span><span class="line">            <span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">){</span>
</span><span class="line">                <span class="c1">// error!</span>
</span><span class="line">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">
</span><span class="line">        <span class="p">))</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="p">}])</span><span class="c1">// end controller</span>
</span><span class="line">
</span><span class="line"><span class="nx">app</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;CbgenRestangular&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">Restangular</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">Restangular</span><span class="p">.</span><span class="nx">withConfig</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">RestangularConfigurer</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">RestangularConfigurer</span><span class="p">.</span><span class="nx">setBaseUrl</span><span class="p">(</span><span class="s1">&#39;/api/v1&#39;</span><span class="p">);</span>
</span><span class="line">    <span class="p">});</span>
</span><span class="line"><span class="p">})</span>
</span><span class="line">
</span><span class="line"><span class="nx">populate_scope_values</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">description</span><span class="o">:</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">description</span> <span class="p">};</span>
</span><span class="line"><span class="p">},</span>
</span><span class="line">
</span><span class="line"><span class="nx">create_resource</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">CbgenRestangular</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">post_data</span> <span class="o">=</span> <span class="nx">populate_scope_values</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">CbgenRestangular</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;job/&#39;</span><span class="p">).</span><span class="nx">post</span><span class="p">(</span><span class="nx">post_data</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-2">Что дальше</h2>

<p>Материала слишком много для одного поста в блоге. Дальше - практиковаться и изучать <a href="https://egghead.io/lessons">видео уроки по AngularJS</a>.</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Передовые паттерны проектирования в Python]]></title>
    <link href="http://toly.github.io/blog/2014/03/05/advanced-design-patterns-in-python/"/>
    <updated>2014-03-05T19:56:33+04:00</updated>
    <id>http://toly.github.io/blog/2014/03/05/advanced-design-patterns-in-python</id>
    <content type="html"><![CDATA[<blockquote>
  <p>Перевод статьи <a href="http://pypix.com/python/advanced-data-structures/">Advanced Design Patterns in Python</a></p>
</blockquote>

<p>Цель данной статьи - показать передовые паттерны в Python и лучший способ их использовать. В зависимости от того, что вам нужно от структуры кода, будь то быстрый поиск, постоянство, индексация и т.д., вы можете выбрать оптимальную структуру для работы, и большую часть времени вы будете смешивать их вместе что бы получить логичную и простую для понимания модель данных. Паттерны в Python очень интуитивны с точки зрения синтаксиса и они предлагают большой выбор операций. Это руководство пытается собрать наиболее распространенную и полезную информацию о каждом паттерне, а так же советы о том когда лучше всего использовать тот или иной паттерн.</p>

<!-- more -->

<h2 id="section">Генераторы</h2>

<p>Если вы очень долго используете Python, скорее всего вы слышали о генераторах списков. Они подходят для цикла, блока <strong>if</strong> и способны уместить  все это в одну строку. Другими словами, вы можете отобразить (<strong>map</strong>) и отфильтровать (<strong>filter</strong>) список одним выражением.</p>

<p>Генератор списка состоит из следующих частей:</p>

<ul>
  <li>входная последовательность</li>
  <li>переменная, представляющая элементы входной последовательности</li>
  <li>условие (опционально)</li>
  <li>выходное выражение, полученное из элементов входного списка, которые удовлетворяют условию</li>
</ul>

<p>Допустим, нам нужно получить список всех квадратов целых чисел, которые больше нуля:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="n">filtered_and_squared</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
</span><span class="line">    <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">filtered_and_squared</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span> <span class="n">filtered_and_squared</span>
</span><span class="line">
</span><span class="line"><span class="c"># [1, 16, 100, 4, 9]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Согласитесь, довольно просто? Но это занимает 4-е строчки, 2-у уровня вложенности, и вдобавок мы делаем довольно тривиальную вещь. Вы можете уменьшить количество кода с помощью функций <strong>filter</strong>, <strong>lambda</strong> и <strong>map</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="n">filtered_and_squared</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
</span><span class="line"><span class="k">print</span> <span class="n">filtered_and_squared</span>
</span><span class="line">
</span><span class="line"><span class="c"># [1, 16, 100, 4, 9]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Теперь код расширяется горизонтально! Что можно сделать, что бы упростить код? Применить генераторы списков.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="n">filtered_and_squared</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">num</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span class="line"><span class="k">print</span> <span class="n">filtered_and_squared</span>
</span><span class="line">
</span><span class="line"><span class="c"># [1, 16, 100, 4, 9]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Генератор списков заключен в квадратные скобки, таким образом, видно что список производится сразу. В этом генераторе списка только один вызов функции и нет вызовов загадочной <strong>lambda</strong> - используется обычный итератор, выходное выражение и опциональное условие.</p>

<p>Но, есть и минусы: результирующий списов вычисляется и сохраняется в память сразу. Это не проблема для небольших списков, наподобие приведенных выше, или даже списков на порядок больших. Но иногда это может быть неэффективно.</p>

<p><strong>Генераторы</strong> выручат и сейчас. Выражение-генератор не загружает весь список в память сразу, а вместо этого создает объект генератора, поэтому за один раз можно получить только один элемент.</p>

<p>Выражения-генераторы имеют синтаксис, похожий на синтаксис генераторов списков, только вместо квадратных скобок - круглые:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line"><span class="n">filtered_and_squared</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">num</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class="line"><span class="k">print</span> <span class="n">filtered_and_squared</span>
</span><span class="line">
</span><span class="line"><span class="c"># &lt;generator object &lt;genexpr&gt; at 0x00583E18&gt;</span>
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">filtered_and_squared</span><span class="p">:</span>
</span><span class="line">    <span class="k">print</span> <span class="n">item</span>
</span><span class="line">
</span><span class="line"><span class="c"># 1, 16, 100 4,9</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Это даже немного эффективнее использования генераторов списков. Заменим пример более эффективным кодом:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">square_generator</span><span class="p">(</span><span class="n">optional_parameter</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">num</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">optional_parameter</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">print</span> <span class="n">square_generator</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line"><span class="c"># &lt;generator object &lt;genexpr&gt; at 0x004E6418&gt;</span>
</span><span class="line">
</span><span class="line"><span class="c"># Option I</span>
</span><span class="line"><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">square_generator</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
</span><span class="line">    <span class="k">print</span> <span class="n">k</span>
</span><span class="line"><span class="c"># 1, 16, 100, 4, 9</span>
</span><span class="line">
</span><span class="line"><span class="c"># Option II</span>
</span><span class="line"><span class="n">g</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">square_generator</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span class="line"><span class="k">print</span> <span class="n">g</span>
</span><span class="line"><span class="c"># [1, 16, 100, 4, 9]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Использование выражения-генератора вероятно более хорошая практика, но вы не увидите разницы в эффективности, если список не очень велик.</p>

<p>Так же, вы можете использовать функцию <strong>zip</strong> для работы с двумя и более элементами за раз:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">alist</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;a1&#39;</span><span class="p">,</span> <span class="s">&#39;a2&#39;</span><span class="p">,</span> <span class="s">&#39;a3&#39;</span><span class="p">]</span>
</span><span class="line"><span class="n">blist</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;3&#39;</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alist</span><span class="p">,</span> <span class="n">blist</span><span class="p">):</span>
</span><span class="line">    <span class="k">print</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
</span><span class="line">
</span><span class="line"><span class="c"># a1 1</span>
</span><span class="line"><span class="c"># a2 2</span>
</span><span class="line"><span class="c"># a3 3</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Пример двухуровневого генератора с использованием <strong>os.walk()</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="k">def</span> <span class="nf">tree</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
</span><span class="line">    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
</span><span class="line">        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
</span><span class="line">            <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">(</span><span class="s">&#39;C:\Users\XXX\Downloads\Test&#39;</span><span class="p">):</span>
</span><span class="line">    <span class="k">print</span> <span class="n">name</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-1">Декораторы</h2>

<p>Декораторы предоставляют очень удобный метод для добавления функциональности для существующих функций и классов. Похоже на АОП (аспектно-ориентированное программирование) в Java, не так ли? Кроме того, что это проще, а значит мощнее. Например, предположим вам нужно что-либо сделать на точках входа и выхода их функции (защиту, отслеживание, блокирование и др. - стандартные элементы АОП).</p>

<p>Декоратор - это функция, которая обертывает другую функцию: вызывается основная функция и ее результат передается в декоратор. Затем декоратор возвращает функцию, которая заменяет оборачиваемую функцию так как нужно.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">timethis</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;</span>
</span><span class="line"><span class="sd">    Decorator that reports the execution time.</span>
</span><span class="line"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="line">    <span class="k">pass</span>
</span><span class="line">
</span><span class="line"><span class="nd">@timethis</span>
</span><span class="line"><span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span class="line">    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Символ <strong>@</strong> указывает на применение декоратора.</p>

<p>Теперь давайте реализуем код декоратора. Здесь мы фактически используем код декорируемой функции:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">time</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">timethis</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&#39;&#39;&#39;</span>
</span><span class="line"><span class="sd">    Decorator that reports the execution time.</span>
</span><span class="line"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="line">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">        <span class="k">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">result</span>
</span><span class="line">    <span class="k">return</span> <span class="n">wrapper</span>
</span><span class="line">
</span><span class="line"><span class="nd">@timethis</span>
</span><span class="line"><span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span class="line">    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line"><span class="n">countdown</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># (&#39;countdown&#39;, 0.006999969482421875)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Когда вы пишете код вроде этого:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@timethis</span>
</span><span class="line"><span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>это то же самое, как если бы выполнялось следующее</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span class="line">	<span class="o">...</span>
</span><span class="line">
</span><span class="line"><span class="n">countdown</span> <span class="o">=</span> <span class="n">timethis</span><span class="p">(</span><span class="n">countdown</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Код внитри декоратора обычно включает в себя создание новой функции, которая принимает любые аргументы (с использованием *args и **kwargs) как показано в случае с функцией wrapper в этом примере. Внутри этой функции вы принимает входные аргументы оригинальной функции и возвращаете результат. Однако, вы так же можете разместить там дополнительный код (например, замер времени и т.д.). Таким образов созданная функция-обертка возвращает результат, как если бы это была оригинальная функция.</p>

<p>Давайте рассмотрим другой пример:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="nd">@decorator</span>
</span><span class="line"><span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span><span class="p">(</span><span class="s">&quot;inside function&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Когда компилятор проходит этот код, <code>function()</code> компилируется и получившийся объект-функция передается в код декоратора <code>decorator</code>, который создает из нее другой объект-функцию, что бы заменить первоначальную функцию <code>function()</code>.</p>

<p>Как выглядит код декоратора? В основном в примерах показывают его как функцию, но я обнаружил, что легче разобраться в декораторах с помощью классов. Кроме того, классы дают больше возможностей.</p>

<p>Единственное ограничение на результат возвращаемый декоратором, это то, что он может быть вызван как функция - т.е. что его можно вызвать. Таким образом, любые классы, которые мы используем в качестве декораторов должны быть с методом <code>__call__</code>.</p>

<p>Что должен делать декоратор после вызова? Вообще-то, все что угодно, но обычно ожидается, что будет использован код оригинальной функции. Однако, это не обязательно:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">decorator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span><span class="p">(</span><span class="s">&quot;inside decorator.__init__()&quot;</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span><span class="p">()</span> <span class="c"># Prove that function definition has completed</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span><span class="p">(</span><span class="s">&quot;inside decorator.__call__()&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="nd">@decorator</span>
</span><span class="line"><span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
</span><span class="line">    <span class="k">print</span><span class="p">(</span><span class="s">&quot;inside function()&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">&quot;Finished decorating function()&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">function</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="c"># inside decorator.__init__()</span>
</span><span class="line"><span class="c"># inside function()</span>
</span><span class="line"><span class="c"># Finished decorating function()</span>
</span><span class="line"><span class="c"># inside decorator.__call__()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Практический пример:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="n">variable</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;variable&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class="line">        <span class="k">print</span> <span class="n">variable</span>
</span><span class="line">        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
</span><span class="line">    <span class="k">return</span> <span class="n">modify</span>
</span><span class="line">
</span><span class="line"><span class="nd">@decorator</span>
</span><span class="line"><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
</span><span class="line">    <span class="k">print</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span>
</span><span class="line">    <span class="k">return</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span>
</span><span class="line">
</span><span class="line"><span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s">&quot;hi&quot;</span><span class="p">)</span>
</span><span class="line"><span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># hi</span>
</span><span class="line"><span class="c"># 16 25</span>
</span><span class="line"><span class="c"># None</span>
</span><span class="line"><span class="c"># 16 25</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="contextlib--">ContextLib (менеджеры контекста)</h2>

<p>Модуль <strong>contextlib</strong> содержит средства для работы с менеджерами контекста и оператором <strong>with</strong>. Обычно, что бы написать менеджер контекста, вы определяете класс с методами <code>__enter__()</code> и <code>__exit__()</code>. Например:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">time</span>
</span><span class="line"><span class="k">class</span> <span class="nc">demo</span><span class="p">:</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_ty</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
</span><span class="line">        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Полный пример:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">time</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">demo</span><span class="p">:</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_ty</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
</span><span class="line">        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="k">with</span> <span class="n">demo</span><span class="p">(</span><span class="s">&#39;counting&#39;</span><span class="p">):</span>
</span><span class="line">    <span class="n">n</span> <span class="o">=</span> <span class="mi">10000000</span>
</span><span class="line">    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line"><span class="c"># counting: 1.36000013351</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Менеджер контекста “включается” оператором <strong>with</strong>. Возвращаемый объект будет использоваться в контексте. Метод <code>__enter__()</code> выполняется, когда поток управления входит в блок кода внутри оператора <strong>with</strong>. Когда поток управления покидает блок кода внутри <strong>with</strong>, вызывается метод <code>__exit__()</code>, что бы очистить используемые ресурсы.</p>

<p>Заново напишем исходный пример, используя декоратор <code>@contextmanager</code> из модуля <strong>contextlib</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">time</span>
</span><span class="line">
</span><span class="line"><span class="nd">@contextmanager</span>
</span><span class="line"><span class="k">def</span> <span class="nf">demo</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
</span><span class="line">    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="k">yield</span>
</span><span class="line">    <span class="k">finally</span><span class="p">:</span>
</span><span class="line">        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="k">with</span> <span class="n">demo</span><span class="p">(</span><span class="s">&#39;counting&#39;</span><span class="p">):</span>
</span><span class="line">    <span class="n">n</span> <span class="o">=</span> <span class="mi">10000000</span>
</span><span class="line">    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line"><span class="c"># counting: 1.32399988174</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>В функции <code>demo(label)</code> весь код до оператора <strong>yield</strong> исполняется как метод менеджера контекста <code>__enter__()</code>. Весь код после оператора <strong>yield</strong> выполняется как метод <code>__exit__()</code>. Если в блоке внутри <strong>with</strong> возникнет исключение, оно “объявится” на месте оператора <strong>yield</strong>.</p>

<h2 id="section-2">Дескрипторы</h2>

<p>Дескрипторы определяют как осуществляется доступ к аттрибутам объекта. Дескриптор является способом изменить то, что происходит, когда вы обращаетесть к аттрибуту объекта.</p>

<p>Что бы создать дескриптор, нужно определить хотя бы один из следующих трех методов. Обратите внимание, что <code>instance</code> - это объект, к аттрибуту которого меняется доступ, а <code>owner</code> - класс, для которого дескриптор является аттрибутом.</p>

<p><code>__get__(self, instance, owner)</code> - вызывается, когда запрашивается аттрибут (value = obj.attr); то что возвращается будет передано коду, запрашивающему аттрибут.</p>

<p><code>__set__(self, instance, value)</code> - вызывается, когда аттрибуту устанавливается значение (obj.attr = value); ничего не возвращает.</p>

<p><code>__delete__(self, instance)</code> - вызывается, когда аттрибут объекта удалаяется (del obj.attr)</p>

<p>Ленивые аттрибуты:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">weakref</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">lazyattribute</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span><span class="line">            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="nd">@lazyattribute</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Being lazy&quot;</span>
</span><span class="line">        <span class="k">return</span> <span class="mi">42</span>
</span><span class="line">
</span><span class="line"><span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">bar</span>
</span><span class="line"><span class="c"># Being lazy</span>
</span><span class="line"><span class="c"># 42</span>
</span><span class="line">
</span><span class="line"><span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">bar</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<blockquote>
  <p>Дескрипторы - это обобщение концепции связанных методов, лежащих в основе реализации классических классов. В классических классах, когда аттрибут экзампляра не найден в словаре экземпляра, поиск продолжается в словаре класса, а затем рекурсивно в словарях базовых классов. Когда аттрибут найден в словаре класса (не в словаре экземпляра), интерпретатор проверяет, является ли найденный объект функцией. Если это так, то возвращается не найденный объект, а обернутый объект, который действует как каррированая функция. Когда вызывается обернутый объект, он вызывает оригинальную функцию с экземпляром в качестве одного из аргументов.</p>
</blockquote>

<p>Как отмечено выше, дескрипторы закрепляются за классом, и когда осуществляется доступ к аттрибуту, автоматически вызываются специальные методы, причем используемый метод зависит от того, какой типа доступа осуществляется.</p>

<h2 id="section-3">Метаклассы</h2>

<p>Метаклассы предлагают мощный способ изменить поведение классов в Python.</p>

<p>Метакласс определяется как “класса класса”. Любой класс, экземпляры которого являются сами классы, является метаклассом.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">demo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">    <span class="k">pass</span>
</span><span class="line">
</span><span class="line"><span class="n">obj</span> <span class="o">=</span> <span class="n">demo</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="k">print</span> <span class="s">&quot;Class of obj is {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span> <span class="s">&quot;Class of obj is {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">demo</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Class of obj is &lt;class &#39;__main__.demo&#39;&gt;</span>
</span><span class="line"><span class="c"># Class of obj is &lt;type &#39;type&#39;&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Мы создали класс и объект этого класса. Запросив у экземпляра аттрибут <code>__class__</code>, мы увидели, что это <code>demo</code>. Дальше интереснее. Что такое класс <code>demo</code>? У него мы тоже можем посмотреть аттрибут <code>__class__</code> - это <code>type</code>.</p>

<p>Итак, <code>type</code> - это класс классов в Python. Другими словами, в приведенном выше примере <code>obj</code> - это объект класса <code>demo</code>, сам класс <code>demo</code> является объектом <code>type</code>.</p>

<p>Таким образом это делает <code>type</code> метаклассом - в действительности наиболее часто используемый метакласс в Python, т.к. это дефолтный метакласс для всех классов.</p>

<p>Т.к. метакласс - это класс классов, он используется для создания классов (тех, что создают объекты). Но подождите, не мы ли создаем классы, когда определяем их стандартным способом? Все верно, но то что делает Python “под капотом” выглядит так:</p>

<ul>
  <li>когда встречается определение класса, Python собирает аттрибуты (включая методы) в словарь</li>
  <li>когда определение класса закончилось, Python определяет для него метакласс; давайте назовем его <em>Meta</em></li>
  <li>после Python выполняет <code>Meta(name, bases, dct)</code>, где:
    <ul>
      <li><code>Meta</code> - это метакласс, поэтому этот вызов создает его экземпляр</li>
      <li><code>name</code> - это имя только что созданного класса</li>
      <li><code>bases</code> - это кортеж базовых классов</li>
      <li><code>dct</code> - словарь, связывающий названия аттрибутов с объектами; в нем перечислены все аттрибуты класса</li>
    </ul>
  </li>
</ul>

<p>Как определить какой метакласс у класса? Если у класса (или один из его базовых классов) имеет аттрибут <code>__metaclass__</code>, то он считается метаклассом. В противном случае, метаклассом является <strong>type</strong>.</p>

<h2 id="section-4">Паттерны</h2>

<p><strong>“Проще просить прощения, чем разрешения”</strong></p>

<p>Один из принципов Python - “Проще просить прощения, чем разрешения”. В отличие от подхода “семь раз отмерь”, этот принцип заключается в том, что сначала вы должны попытаться выполнить действие и если возникает ошибка - реагировать соответствующим образом. Продвинутая обработка исключений в Python поддерживает этот принцип и помогает разрабатывать надежные и устойчивые программы.</p>

<p><strong>Синглтон (одиночка)</strong></p>

<p>Синглтон - это объекты, предполагающие наличие только одного экземпляра. Python предоставляет несколько путей для реализации синглтонов.</p>

<p><strong>Null object</strong></p>

<p>Null object может быть использован вместо <strong>None</strong>, что бы избежать проверки на None.</p>

<p><strong>Обозреватель</strong></p>

<p>Паттерн обозреватель позволяет нескольким объектам иметь доступ к общим данным.</p>

<p><strong>Конструктор</strong></p>

<p>Параметры конструктора часто назначаются переменным экземпляра. Этот паттерн может заменить много строк ручного присваивания одной строчкой.</p>

<h2 id="section-5">Заключение</h2>

<p>Спасибо за чтение. Оставляйте свои ​​комментарии для дальнейшего обсуждения.</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Многопоточность в одну строку]]></title>
    <link href="http://toly.github.io/blog/2014/02/13/parallelism-in-one-line/"/>
    <updated>2014-02-13T13:53:13+04:00</updated>
    <id>http://toly.github.io/blog/2014/02/13/parallelism-in-one-line</id>
    <content type="html"><![CDATA[<blockquote>
  <p>Перевод статьи Криса Кила <a href="https://medium.com/p/40e9b2b36148">Parallelism in one line</a></p>
</blockquote>

<p>Python имеет ужасную репутацию, когда речь идет о возможности параллельных вычислений. Не обращая внимания на типичные рассуждения о его потоках и GIL (который обычно нормально работает), по-моему реальная проблема многопоточности Python не техническая, а педагогическая. Распространенные руководства о библиотеках <strong>threading</strong> и <strong>multiprocessing</strong> в целом неплохие, но тяжеловаты для понимания. Они начинаются с глубоких вещей, и заканчиваются до просто применяемых практик.</p>

<!-- more -->

<h2 id="section">Традиционный пример</h2>

<p>Беглое ознакомление с первыми результатами поискового запроса на тему “Python threading tutorial” показывает, что почти каждый из них основан на  использовании какого-либо вспомогательного класса в связке с модулем <strong>Queue</strong>.</p>

<p>Типичный пример многопоточности вида поставщик-потребитель:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c">#Example.py</span>
</span><span class="line"><span class="sd">&#39;&#39;&#39;</span>
</span><span class="line"><span class="sd">Standard Producer/Consumer Threading Pattern</span>
</span><span class="line"><span class="sd">&#39;&#39;&#39;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">time</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">threading</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">Queue</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Consumer</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
</span><span class="line">		<span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class="line">		<span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">		<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">			<span class="c"># queue.get() blocks the current thread until </span>
</span><span class="line">			<span class="c"># an item is retrieved. </span>
</span><span class="line">			<span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span class="line">			<span class="c"># Checks if the current message is </span>
</span><span class="line">			<span class="c"># the &quot;Poison Pill&quot;</span>
</span><span class="line">			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">msg</span> <span class="o">==</span> <span class="s">&#39;quit&#39;</span><span class="p">:</span>
</span><span class="line">				<span class="c"># if so, exists the loop</span>
</span><span class="line">				<span class="k">break</span>
</span><span class="line">			<span class="c"># &quot;Processes&quot; (or in our case, prints) the queue item	</span>
</span><span class="line">			<span class="k">print</span> <span class="s">&quot;I&#39;m a thread, and I received </span><span class="si">%s</span><span class="s">!!&quot;</span> <span class="o">%</span> <span class="n">msg</span>
</span><span class="line">		<span class="c"># Always be friendly! </span>
</span><span class="line">		<span class="k">print</span> <span class="s">&#39;Bye byes!&#39;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">Producer</span><span class="p">():</span>
</span><span class="line">	<span class="c"># Queue is used to share items between</span>
</span><span class="line">	<span class="c"># the threads.</span>
</span><span class="line">	<span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">	<span class="c"># Create an instance of the worker</span>
</span><span class="line">	<span class="n">worker</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
</span><span class="line">	<span class="c"># start calls the internal run() method to </span>
</span><span class="line">	<span class="c"># kick off the thread</span>
</span><span class="line">	<span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">	<span class="c"># variable to keep track of when we started</span>
</span><span class="line">	<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">	<span class="c"># While under 5 seconds.. </span>
</span><span class="line">	<span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span class="line">		<span class="c"># &quot;Produce&quot; a piece of work and stick it in </span>
</span><span class="line">		<span class="c"># the queue for the Consumer to process</span>
</span><span class="line">		<span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;something at </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span class="line">		<span class="c"># Sleep a bit just to avoid an absurd number of messages</span>
</span><span class="line">		<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">	<span class="c"># This the &quot;poison pill&quot; method of killing a thread. </span>
</span><span class="line">	<span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;quit&#39;</span><span class="p">)</span>
</span><span class="line">	<span class="c"># wait for the thread to close down</span>
</span><span class="line">	<span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">	<span class="n">Producer</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Мда… Просматриваются Java’вские корни.</p>

<p>Что ж, я не хочу, что бы у вас создалось впечатление, будто схема поставщик-потребитель плоха для многопоточной разработки - это определенно не так. На самом деле такой способ хорошо подходит для решения множества задач. Однако, я думаю, что это не подходит для ежедневного применения.</p>

<h2 id="section-1">Проблемы (на мой взгляд)</h2>

<p>Во-первых, вам нужен шаблонный класс, который делает то, что нужно. Во-вторых, вам нужно организовать очередь, согласно которой будут обрабатываться объекты; и наконец, вам нужны методы для входа в очередь и выхода из очереди что бы делать реальную работу (скорее всего, с участием другой очереди, если вы хотите получать обратную связь или сохранять результаты работы).</p>

<h3 id="section-2">Больше воркеров, больше задач</h3>

<p>Следующее, что вы вероятно сделаете, это пулл воркеров, что бы выжать из Python больше производительности. Ниже приводится измененный код примера из превосходного <a href="http://www.ibm.com/developerworks/aix/library/au-threadingpython/">руководства</a> по многопоточности от IBM. Это достаточно распространенный сценарий, когда вы распределяете задачи получения веб-страниц на несколько потоков.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c">#Example2.py</span>
</span><span class="line"><span class="sd">&#39;&#39;&#39;</span>
</span><span class="line"><span class="sd">A more realistic thread pool example </span>
</span><span class="line"><span class="sd">&#39;&#39;&#39;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">time</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">threading</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">Queue</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">urllib2</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Consumer</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
</span><span class="line">		<span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class="line">		<span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">		<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">			<span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span class="line">			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">content</span> <span class="o">==</span> <span class="s">&#39;quit&#39;</span><span class="p">:</span>
</span><span class="line">				<span class="k">break</span>
</span><span class="line">			<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span class="line">		<span class="k">print</span> <span class="s">&#39;Bye byes!&#39;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">Producer</span><span class="p">():</span>
</span><span class="line">	<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">		<span class="s">&#39;http://www.python.org&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.yahoo.com&#39;</span>
</span><span class="line">		<span class="s">&#39;http://www.scala.org&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.google.com&#39;</span>
</span><span class="line">		<span class="c"># etc.. </span>
</span><span class="line">	<span class="p">]</span>
</span><span class="line">	<span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span class="line">	<span class="n">worker_threads</span> <span class="o">=</span> <span class="n">build_worker_pool</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span class="line">	<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">	<span class="c"># Add the urls to process</span>
</span><span class="line">	<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
</span><span class="line">		<span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>	
</span><span class="line">	<span class="c"># Add the poison pillv</span>
</span><span class="line">	<span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">worker_threads</span><span class="p">:</span>
</span><span class="line">		<span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;quit&#39;</span><span class="p">)</span>
</span><span class="line">	<span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">worker_threads</span><span class="p">:</span>
</span><span class="line">		<span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">	<span class="k">print</span> <span class="s">&#39;Done! Time taken: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">build_worker_pool</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span class="line">	<span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">	<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
</span><span class="line">		<span class="n">worker</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
</span><span class="line">		<span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class="line">		<span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
</span><span class="line">	<span class="k">return</span> <span class="n">workers</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">	<span class="n">Producer</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Работает отлично, но посмотрите на весь этот код! Здесь методы инициализации, списки потоков для отслеживания работы, и что хуже всего, если вы склонны к обработке блокировок как и я, куча вызовов метода <strong>join</strong>. А впоследствии будет еще сложнее!</p>

<p>А что было сделано? Да практически ничего. Вышеприведенный код представляет собой хрупкую конструкцию. Это внимательное следование шаблону, это высокая вероятность ошибок (я даже забыл вызвать метод <em>task_done()</em> в объекте очереди пока писал это), и это писать много кода и получать мало функционала. К счастью, есть гораздо лучший способ.</p>

<h2 id="map">Знакомьтесь: <strong>Map</strong></h2>

<p><em>Map</em> - это класная маленькая функция, а главное, проста для распараллеливания вашего Python кода. Для тех, кто не вкурсе, <em>map</em> заимствована из функциональных языков, вроде Lisp’а. Это функция, которая применяет другую функцию к последовательности, например:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;http://www.yahoo.com&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.reddit.com&#39;</span><span class="p">]</span>
</span><span class="line"><span class="n">results</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">,</span> <span class="n">urls</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Этот код применяет метод <em>urlopen</em> к каждому элементу переданной последовательности и сохраняет полученные результаты в список. Это более-менее эквивалентно следующему коду:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line"><span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
</span><span class="line">    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Функция <em>map</em> управляет итерацией последовательности, применяет нужную функцию, и в конце сохраняет все получившиеся результаты в список.</p>

<p>Почему это имеет значение? Потому, что используя определенные библиотеки, <em>map</em> делает использование многопоточности тривиальным!</p>

<p>Функция <em>map</em> с поддержкой многопоточности присутствует в двух библиотеках: <strong>multiprocessing</strong>, а так же малоизвестная, но неменее замечательная - <strong>multiprocessing.dummy</strong>.</p>

<p><em>Отступление:</em> Что это? Никогда не слышал о многопоточном клоне библиотеки <strong>multiprocessing</strong> под названием <em>dummy</em>? Я тоже не слышал до недавнего времени. Есть всего одно предложение на странице официальной документации библиотеки <strong>multiprocessing</strong>. И это предложение сводится к “Ах да, эта вещь существует”. Это печально, скажуя вам!</p>

<p><strong>multiprocessing.dummy</strong> представляет собой точный аналог модуля <strong>multiprocessing</strong>. Разница лишь в том, что <strong>multiprocessing</strong> работает с процессами, а <strong>multiprocessing.dummy</strong> использует треды (со всеми присущими им ограничениями). Поэтому, все что относится к одной библиотеке, относится и к другой. Это делает переключение между ними довольно простым.</p>

<h2 id="section-3">Приступим</h2>

<p>Для доступа к map-параллельной функции, сперва нужно импортировать модули в которых она содержится и создать пулл:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ThreadPool</span>
</span><span class="line">
</span><span class="line"><span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Последнее выражение делает то же, что и семистрочная функция <em>build_worker_pool</em> в приведенном ранее примере. А именно, создает кучу доступных воркеров, поготавливает их к выполнению задач, и сохраняет их в переменной, что бы к ним было легко обратиться.</p>

<p>Объекты из пула принимают несколько параметров, но сейчас упоминания стоит только один: <em>processes</em>. Этот параметр устанавливает количество воркеров в пуле. Если оставить это поле пустым, то по умолчанию оно будет равно количеству ядер в вашем процессоре.</p>

<p>В общем случае, если вы используете многопроцессовый пулл для ядро-раздельных задач, то больше ядер означает большуую скорость (я говорю это с многочисленными оговорками). Однако, когда речь идет о многопоточной обработке и делах связанных с сетью, это не так, и будет хорошей идеей поэксперементировать с размером пула.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c"># Sets the pool size to 4</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Если вы запустите слишком много потоков, вы затратите больше времени на переключения между ними, чем на полезную работу, так что в этом случае неплох поизменять параметры до тех пор, пока не найдет оптимальный вариант для вашей задачи.</p>

<p>Итак, теперь, когда созданы воркеры и простой способ распараллеливания в наших руках, давайте перепишем загрузку веб-страниц из предыдущего примера.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">urllib2</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">ThreadPool</span>
</span><span class="line">
</span><span class="line"><span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="line">	<span class="s">&#39;http://www.python.org&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://www.python.org/about/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://www.onlamp.com/pub/a/python/2003/04/17/metaclasses.html&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://www.python.org/doc/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://www.python.org/download/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://www.python.org/getit/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://www.python.org/community/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;https://wiki.python.org/moin/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://planet.python.org/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;https://wiki.python.org/moin/LocalUserGroups&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://www.python.org/psf/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://docs.python.org/devguide/&#39;</span><span class="p">,</span>
</span><span class="line">	<span class="s">&#39;http://www.python.org/community/awards/&#39;</span>
</span><span class="line">	<span class="c"># etc.. </span>
</span><span class="line">	<span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># Make the Pool of workers</span>
</span><span class="line"><span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Open the urls in their own threads</span>
</span><span class="line"><span class="c"># and return the results</span>
</span><span class="line"><span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">,</span> <span class="n">urls</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c">#close the pool and wait for the work to finish </span>
</span><span class="line"><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line"><span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Посмотрите на это! Код который на самом деле работает занимает 4 строки, 3 из которых формальны. Функция <strong>map</strong> сделала то же, что и предыдущий код в 40 строк с такой легкостью! Для проверки я испробовал оба подхода и попробовал различные размеры пула.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line"><span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
</span><span class="line">	<span class="n">result</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">	<span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># ------- VERSUS ------- # </span>
</span><span class="line">
</span><span class="line"><span class="c"># ------- 4 Pool ------- # </span>
</span><span class="line"><span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class="line"><span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">,</span> <span class="n">urls</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># ------- 8 Pool ------- # </span>
</span><span class="line"><span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span class="line"><span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">,</span> <span class="n">urls</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># ------- 13 Pool ------- # </span>
</span><span class="line"><span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
</span><span class="line"><span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">,</span> <span class="n">urls</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-4">Результаты:</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"> 						<span class="n">Single</span> <span class="n">thread</span><span class="p">:</span>  <span class="mf">14.4</span> <span class="n">Seconds</span>
</span><span class="line"> 						       <span class="mi">4</span> <span class="n">Pool</span><span class="p">:</span>   <span class="mf">3.1</span> <span class="n">Seconds</span>
</span><span class="line"> 						       <span class="mi">8</span> <span class="n">Pool</span><span class="p">:</span>   <span class="mf">1.4</span> <span class="n">Seconds</span>
</span><span class="line"> 						      <span class="mi">13</span> <span class="n">Pool</span><span class="p">:</span>   <span class="mf">1.3</span> <span class="n">Seconds</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Потрясающе! Это так же показывает, почему полезно поэкспериментировать с размером пула. Любой пулл с более чем 9 воркерами быстро приводит в падению прироста скорости (на этом компе).</p>

<h1 id="section-5">Реальный пример №2</h1>
<p>Создание миниатюр для тысяч изображений</p>

<p>Теперь давайте сделаем что-нибудь процесорно-раздельное! Довольно распространенная задача у меня на работе - это обработка больших коллекций картинок. Одна из таких задач - создание миниатюр. И это можно распараллелить.</p>

<h2 id="section-6">Простая однопроцессная реализация</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span><span class="line">
</span><span class="line"><span class="n">SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
</span><span class="line"><span class="n">SAVE_DIRECTORY</span> <span class="o">=</span> <span class="s">&#39;thumbs&#39;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_image_paths</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span class="line">            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="s">&#39;jpeg&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">create_thumbnail</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span class="line">    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class="line">    <span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
</span><span class="line">    <span class="n">base</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class="line">    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">SAVE_DIRECTORY</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span class="line">    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">    <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;images_path&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">SAVE_DIRECTORY</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">    <span class="n">images</span> <span class="o">=</span> <span class="n">get_image_paths</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
</span><span class="line">        <span class="n">create_thumbnail</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Пример несколько адаптирован, но по сути происходит следующее: каталог с изображениями передается в программу, потом из каталога выбираются все картинки, и наконец создаются миниатюры и сохраняются в отдельный каталог.</p>

<p>На моем компьютере это выполняется за 27.9 секунд для порядка 6000 изображений.</p>

<p>Если мы заменим цикл <strong>for</strong> параллельной функцией <strong>map</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
</span><span class="line">
</span><span class="line"><span class="n">SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
</span><span class="line"><span class="n">SAVE_DIRECTORY</span> <span class="o">=</span> <span class="s">&#39;thumbs&#39;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_image_paths</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span class="line">    <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span class="line">            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="s">&#39;jpeg&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">create_thumbnail</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span class="line">    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class="line">    <span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
</span><span class="line">    <span class="n">base</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class="line">    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">SAVE_DIRECTORY</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span class="line">    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">    <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">&#39;images_path&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">SAVE_DIRECTORY</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">    <span class="n">images</span> <span class="o">=</span> <span class="n">get_image_paths</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
</span><span class="line">    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_thumbnail</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
</span><span class="line">    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>5.6 секунд!</strong></p>

<p>Это серъезный прирост для изменения всего лишь нескольких строчек кода. Продакшен версия еще быстрее, так как в ней разделены процессорные задачи и задачи ввода-вывода на отдельные процессы и потоки - обычный рецепт для кода с учетом блокировок.</p>

<p>Так что, так. Распараллеливание в одну (почти) строку.</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Начиная Python-проект: The Right Way]]></title>
    <link href="http://toly.github.io/blog/2014/02/09/starting-a-python-project-the-right-way/"/>
    <updated>2014-02-09T21:33:26+04:00</updated>
    <id>http://toly.github.io/blog/2014/02/09/starting-a-python-project-the-right-way</id>
    <content type="html"><![CDATA[<blockquote>
  <p>Достаточно вольный (настолько вольный, что отсутствуют два абзаца и изменен код) перевод статьи Джефа Кнаппа </p>

  <p><a href="http://www.jeffknupp.com/blog/2014/02/04/starting-a-python-project-the-right-way/">Starting A Python Project The Right Way</a></p>
</blockquote>

<p>Если вы подобны большинству начинающих python-программистов, вы вероятно в состоянии представить себе работу приложения целиком, но когда приходит время начать писать код и перед вами пустое окно редактора, вы чувствуете себя потерянным и подавленным. В этой статье я опишу метод, который использую когда начинаю писать программу с нуля. К концу статьи у вас будет хороший план для начала разработки любого приложения.</p>

<!-- more -->

<h2 id="section">Установка</h2>

<p>До того как написать хоть строчку кода, первое что я делаю - создаю <em>виртуальное окружение</em>. Что такое виртуальное окружение? Это установка python отдельно от остальной части системы (и дефолтного pythona’а). Какая от этого польза? Представьте себе, что у вас есть два проекта, над которыми вы работаете. Если оба испольузют какую-либо библиотеку (например, <strong>requests</strong>), и в одном из проектов используется старая версия (которую нельзя корректно обновить, т.к. другие библиотеки используют старую версию <strong>requests</strong>), как вы сможете использовать новую версию <strong>requests</strong> в другом проекте? С помощью виртуального окружения.</p>

<p>Для начала установите <strong>virtualenvwrapper</strong> (обертка над фантастическим пакетом <strong>virtualenv</strong>). Добавьте в ваш <strong>.bashrc</strong> строчку <code>/usr/local/bin/virtualenvwrapper.sh</code> и перезагрузите свой профиль с помощью <strong>source</strong>:</p>

<pre><code>source ~/.bashrc
</code></pre>

<p>Теперь у вас должна появиться команда <strong>mkvirtualenv</strong>, доступная через автодополнение с помощью <em>tab</em>. Если вы используете Python старше версии 3.3, виртуальное окружение поддерживает этот язык и установка этого пакета не требуется. <code>mkvirtualenv &lt;my_project&gt;</code> создаст новое виртуальное окружение под названием my_project с уже установленными <strong>pip</strong> и <strong>setuptools</strong>. Для Python 3 требуемые команды выглядят так:</p>

<pre><code>python -m venv &lt;my_project&gt;
source &lt;my_project&gt;/bin/activate
</code></pre>

<p>Теперь когда виртуальное окружение создано, пришло время инициализировать средство управления исходниками. Предполагая что это <strong>git</strong> (ну, потому что он…), введем</p>

<pre><code>git init .
</code></pre>

<p>Так же полезно добавить в <strong>.gitignore</strong> все скомпилированые Python-ом файлы и каталоги <code>__pychache__</code>. Для этого создайте файл <code>.gitignore</code> и поместите в него следующее:</p>

<pre><code>*.pyc
__pycache__
</code></pre>

<p>Теперь подходящее время добавить в проект <strong>README</strong> файл. Даже если вы единственный, кто будет видеть код, это хорошее упражнение для организации ваших мыслей. <strong>README</strong> файл должен описывать что делает проект, его зависимости и как его использовать. Я пишу <strong>README</strong> файлы с использованием разметки <em>Markdown</em>, во-первых потому что GitHub автоматически оформляет любой файл названный <strong>README.md</strong>, а во-вторых потому что я пишу все (!) документы в разметке <em>Markdown</em>.</p>

<p>И наконец, сделайте первый коммит содержащий два файла (<strong>.gitignore</strong>, <strong>README.md</strong>), которые вы только что создали. Для этого введите:</p>

<pre><code>git add .gitignore README.md
git commit -m "initial commit"
</code></pre>

<h2 id="section-1">Каркасы!</h2>

<p>Почти каждое приложение я начинаю одинаково: создаю каркас приложения, состоящий из функций и классов с заполненой документацией, но без реализации. Я считаю, что необходимо сперва вынужденно писать документацию для функции, иначе если я не способен кратко описать что-либо, то у меня нет достаточно мыслей о проблеме.</p>

<p>В качестве примера приложения я использую скрипт, недавно написанный обучаемым во время одного из наших занятий. Цель скрипта - создать csv-файл, содержащий самые кассовые фильмы прошлого года (по версии IMDB) и ключевые слова связанные с этими фильмами на IMDB. Это был довольно простой проект, для того что бы завершить его за одно занятие, но достаточный по сложности, что бы требовать размышлений.</p>

<p>Сперва создайте основной файл, который будет точкой входа в приложение. Я назвал его <strong>imdb.py</strong>. Потом скопируйте следующий код в редактор:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="s">&quot;&quot;</span><span class="n">Script</span> <span class="n">to</span> <span class="n">gather</span> <span class="n">IMDB</span> <span class="n">keywords</span> <span class="kn">from</span> <span class="mi">2013</span><span class="s">&#39;s top grossing movies.&quot;&quot;&quot;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Main entry point for the script.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">pass</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Звучит неправдоподобно, но это вполне функциональная программа. Вы можете запустить ее и получить правильный код выхода (т.е. <strong>0</strong>, хотя справедливо отметить, что пустой файл будет так же возвращать правильный код). Затем я делаю заглушки для функций и/или классов, которые по моему мнению будут нужны:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="sd">&quot;&quot;&quot;Script to gather IMDB keywords from 2013&#39;s top grossing movies.&quot;&quot;&quot;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line">
</span><span class="line"><span class="n">URL</span> <span class="o">=</span> <span class="s">&quot;http://www.imdb.com/search/title?at=0&amp;sort=boxoffice_gross_us,desc&amp;start=1&amp;year=2013,2013&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Main entry point for the script.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">pass</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_top_grossing_movie_links</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Return a list of tuples containing the top grossing movies of 2013 and link to their IMDB</span>
</span><span class="line"><span class="sd">    page.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">pass</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_keywords_for_movie</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Return a list of keywords associated with *movie*.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="k">pass</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Выглядит сносно. Отмечу, что обе функции включают параметры (например, <strong>get_keywords_for_movie</strong> принимает параметр <strong>url</strong>). Это может показаться странным для заглушек. Зачем здесь параметры? Аргументация такая же, как и для предварительного документирования заглушек: если я не знаю какие агрументы должна принимать функция, значит я недостаточно об этом думал.</p>

<p>В этом месте я верятно закомичусь, т.к. проделал определенную часть работы, которую не хотел бы потерять. После этого перейдем к реализации. Я всегда начинаю с реализации функции <strong>main</strong>, т.к. “центр” использующий все остальные функции. Вот реализация функции <strong>main</strong> в <strong>imdb.py</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">csv</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Main entry point for the script.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="n">movies</span> <span class="o">=</span> <span class="n">get_top_grossing_movie_links</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>
</span><span class="line">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;output.csv&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
</span><span class="line">        <span class="n">csvwriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span class="line">        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">movies</span><span class="p">:</span>
</span><span class="line">            <span class="n">keywords</span> <span class="o">=</span> <span class="n">get_keywords_for_movie</span><span class="p">(</span>
</span><span class="line">                <span class="s">&#39;http://www.imdb.com{}keywords/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span><span class="line">            <span class="n">csvwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">title</span><span class="p">,</span> <span class="n">keywords</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Несмотря на то что <strong>get_top_grossing_movie_links</strong> и <strong>get_keywords_for_movie</strong> не реализованы, я знаю достаточно о том, как их использовать. Функция <strong>main</strong> делает именно то, что мы обсуждали вначале: получает самые кассовые фильмы года и пишет их в csv-файл вместе с их ключевыми словами.</p>

<p>Теперь все что осталось, это реализовать недостающие функции. Любопытно, что даже если мы знаем, что <strong>get_keywords_for_movie</strong> будет вызван после <strong>get_top_grossing_movie_links</strong>, мы можем реализовать их в том порядке, который больше нравится. Это не тот случай, когда пишешь скрипт с нуля и добавляешь функционал в том порядке, в которм идет разработка. Вы были бы вынуждены полностью написать первую функцию, прежде чем перети ко второй. Тот факт, что мы можем реализовать (и проверить!) функции в любом порядкепоказывает, что они слабо связаны.</p>

<p>Давайте первым реализуем функцию <strong>get_keywords_for_movie</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">get_keywords_for_movie</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Return a list of keywords associated with *movie*.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span class="line">    <span class="n">tables</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&#39;table&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&#39;dataTable&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">table</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">    <span class="k">return</span> <span class="p">[</span><span class="n">td</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&#39;tr&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&#39;td&#39;</span><span class="p">)]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Мы используем библиотеки <strong>requests</strong> и <strong>BeautifulSoup</strong>, поэтому нам нужно установить их через <em>pip</em>.	Теперь можно внести в список зависимостей проекта новые библиотеки: <code>pip freeze requirements.txt</code> и закомитить изменения. Таким образом мы всегда сможем создать виртуальное окружение и установить именно те библиотеки (и версии) которые нужны для запуска приложения.</p>

<p>Наконец напишем реализацию для функции <strong>get_top_grossing_movie_links</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">get_top_grossing_movie_links</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Return a list of tuples containing the top grossing movies of 2013 and link to their IMDB</span>
</span><span class="line"><span class="sd">    page.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="n">movies_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">    <span class="k">for</span> <span class="n">each_url</span> <span class="ow">in</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;.title a[href*=&quot;title&quot;]&#39;</span><span class="p">):</span>
</span><span class="line">        <span class="n">movie_title</span> <span class="o">=</span> <span class="n">each_url</span><span class="o">.</span><span class="n">text</span>
</span><span class="line">        <span class="n">movies_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">movie_title</span><span class="p">,</span> <span class="n">each_url</span><span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">]))</span>
</span><span class="line">    <span class="k">return</span> <span class="n">movies_list</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Вот финальное содержание <strong>imdb.py</strong>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="s">&quot;&quot;</span><span class="n">Script</span> <span class="n">to</span> <span class="n">gather</span> <span class="n">IMDB</span> <span class="n">keywords</span> <span class="kn">from</span> <span class="mi">2013</span><span class="s">&#39;s top grossing movies.&quot;&quot;&quot;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">requests</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">csv</span>
</span><span class="line">
</span><span class="line"><span class="n">URL</span> <span class="o">=</span> <span class="s">&quot;http://www.imdb.com/search/title?at=0&amp;sort=boxoffice_gross_us,desc&amp;start=1&amp;year=2013,2013&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_top_grossing_movie_links</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Return a list of tuples containing the top grossing movies of 2013 and link to their IMDB</span>
</span><span class="line"><span class="sd">    page.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="n">movies_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">    <span class="k">for</span> <span class="n">each_url</span> <span class="ow">in</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;.title a[href*=&quot;title&quot;]&#39;</span><span class="p">):</span>
</span><span class="line">        <span class="n">movie_title</span> <span class="o">=</span> <span class="n">each_url</span><span class="o">.</span><span class="n">text</span>
</span><span class="line">        <span class="n">movies_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">movie_title</span><span class="p">,</span> <span class="n">each_url</span><span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">]))</span>
</span><span class="line">    <span class="k">return</span> <span class="n">movies_list</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_keywords_for_movie</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Return a list of keywords associated with *movie*.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span class="line">    <span class="n">tables</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&#39;table&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&#39;dataTable&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">table</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">    <span class="k">return</span> <span class="p">[</span><span class="n">td</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&#39;tr&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">&#39;td&#39;</span><span class="p">)]</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class="line">    <span class="sd">&quot;&quot;&quot;Main entry point for the script.&quot;&quot;&quot;</span>
</span><span class="line">    <span class="n">movies</span> <span class="o">=</span> <span class="n">get_top_grossing_movie_links</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>
</span><span class="line">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;output.csv&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
</span><span class="line">        <span class="n">csvwriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span class="line">        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">movies</span><span class="p">:</span>
</span><span class="line">            <span class="n">keywords</span> <span class="o">=</span> <span class="n">get_keywords_for_movie</span><span class="p">(</span><span class="s">&#39;http://www.imdb.com{}keywords/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span><span class="line">            <span class="n">csvwriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">title</span><span class="p">,</span> <span class="n">keywords</span><span class="p">])</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class="line">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Приложение, которое начиналось с пустого окна редактора готово. После запуска скрипт сгенерирует <strong>output.csv</strong>, содержащий именно то, что нужно. Для скрипта такого размера я не стал бы писать тесты, т.к. результат работы программы и есть тест. Тем не менее, написание тестов в данном случае возможно (так как наши функции слабо связаны), что бы проверить каждую функцию отдельно (изолированно).</p>

<h2 id="section-2">Заключение</h2>

<p>Надеюсь теперь у вас есть план действий для начала работы над python-проектом с нуля. Не смотря на то, что у каждого есть свой метод начала работы над проектом, скорее всего мой метод подойдет и вам. Как всегда, если у вас есть какие-либо вопросы, не стесняйтесь задавать их в комментариях или напишите мне на jeff@jeffknupp.com.</p>
]]></content>
  </entry>
  
</feed>
